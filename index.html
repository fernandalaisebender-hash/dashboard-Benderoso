<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro (V9.0 - Diagn√≥stico)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

    <style>
        :root { --primary: #2c3e50; --bg: #f4f6f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: #333; }
        
        .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid var(--primary); display: flex; justify-content: space-between; align-items: center;}
        
        .kpi-row { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .kpi-card { flex: 1; background: white; padding: 15px; border-radius: 8px; text-align: center; min-width: 150px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .kpi-card h3 { margin: 0 0 5px; font-size: 11px; color: #7f8c8d; text-transform: uppercase; }
        .kpi-card p { margin: 0; font-size: 20px; font-weight: 800; color: var(--primary); }
        
        /* Cores KPI */
        .border-blue { border-top: 3px solid #3498db; }
        .border-red { border-top: 3px solid #e74c3c; }
        .border-green { border-top: 3px solid #27ae60; }
        .border-gold { border-top: 3px solid #f1c40f; }

        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-box { background: white; padding: 15px; border-radius: 8px; height: 300px; }

        .table-box { background: white; padding: 20px; border-radius: 8px; }

        /* Badges de Diagn√≥stico */
        .diag-tag { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; color: #fff; }
        .diag-orc { background-color: #f1c40f; color: #333; }
        .diag-real { background-color: #27ae60; }
        .diag-erro { background-color: #e74c3c; }
        .diag-null { background-color: #95a5a6; }

        .btn-reload { padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;}
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h2 style="margin:0">Painel de Diagn√≥stico</h2>
            <small>Verificando leitura de dados (Or√ßado vs Realizado)</small>
        </div>
        <div>
            <label>M√™s:</label>
            <select id="selMes" onchange="mudarMes()"></select>
            <button class="btn-reload" onclick="location.reload()">Atualizar</button>
        </div>
    </div>

    <div class="kpi-row">
        <div class="kpi-card border-blue">
            <h3>Receita (Real)</h3>
            <p id="kpiReceita">R$ 0,00</p>
        </div>
        <div class="kpi-card border-red">
            <h3>Despesa (Real)</h3>
            <p id="kpiDespesa">R$ 0,00</p>
        </div>
        <div class="kpi-card border-green">
            <h3>Saldo (Real)</h3>
            <p id="kpiSaldo">R$ 0,00</p>
        </div>
        <div class="kpi-card border-gold">
            <h3>Or√ßamento (Plan)</h3>
            <p id="kpiOrcado">R$ 0,00</p>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-box">
            <h4>Or√ßado vs Realizado (Categorias)</h4>
            <canvas id="chartCategorias"></canvas>
        </div>
        <div class="chart-box">
            <h4>Formas de Pagamento</h4>
            <canvas id="chartPagamentos"></canvas>
        </div>
    </div>

    <div class="table-box">
        <h4>üïµÔ∏è Tabela de Diagn√≥stico (Verifique a coluna 'DIAGN√ìSTICO')</h4>
        <table id="tabelaDados" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>DIAGN√ìSTICO (O que o sistema leu)</th>
                    <th>Tipo</th>
                    <th>Categoria</th>
                    <th>Descri√ß√£o</th>
                    <th>Valor</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const LINK_PLANILHA = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_QrNqrn4TJZyIRm8HClxhYEU_vipX5qC_wF5sYmgbfnKPn5gl5HwNUB8SBnK_eI0U8_jiIrb7vTHE/pub?gid=1365210633&single=true&output=csv";

        let DADOS_BRUTOS = [];
        let chartCatInst = null;
        let chartPgtoInst = null;

        window.onload = function() {
            Papa.parse(LINK_PLANILHA, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    DADOS_BRUTOS = results.data;
                    console.log("Colunas encontradas:", Object.keys(DADOS_BRUTOS[0])); // Debug no console
                    configurarFiltroDatas();
                    mudarMes();
                }
            });
        };

        // Fun√ß√£o de Limpeza de Valor
        function cleanVal(v) {
            if(!v) return 0;
            if(typeof v === 'number') return v;
            let s = v.toString().replace("R$", "").replace(/\./g, "").replace(",", ".").trim();
            s = s.replace(/[^0-9.-]/g, ''); 
            return parseFloat(s) || 0;
        }

        // Fun√ß√£o de Extra√ß√£o de Data
        function getMesAno(dataStr) {
            if(!dataStr) return "";
            if(dataStr.includes('/')) {
                let parts = dataStr.split('/');
                if(parts.length >= 3) return `${parts[2].trim()}-${parts[1].trim()}`;
            }
            let d = new Date(dataStr);
            if(!isNaN(d)) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            return "";
        }

        function configurarFiltroDatas() {
            let meses = new Set();
            DADOS_BRUTOS.forEach(r => {
                let kData = Object.keys(r).find(k => k.toLowerCase().trim() === 'data');
                if(kData && r[kData]) {
                    let ma = getMesAno(r[kData]);
                    if(ma.length > 4) meses.add(ma);
                }
            });
            let sorted = Array.from(meses).sort().reverse();
            let sel = document.getElementById("selMes");
            
            let optAll = document.createElement("option"); optAll.value = "todos"; optAll.text = "Todos os Per√≠odos";
            sel.appendChild(optAll);

            sorted.forEach(m => {
                let opt = document.createElement("option");
                let [ano, mes] = m.split('-');
                let nomes = ["","Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
                opt.value = m;
                opt.text = `${nomes[parseInt(mes)]} ${ano}`;
                sel.appendChild(opt);
            });
            
            // Seleciona m√™s atual
            let hoje = new Date();
            let atual = `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,'0')}`;
            if(sorted.includes(atual)) sel.value = atual;
        }

        function mudarMes() {
            let val = document.getElementById("selMes").value;
            let dadosFiltrados;
            
            if(val === "todos") dadosFiltrados = DADOS_BRUTOS;
            else dadosFiltrados = DADOS_BRUTOS.filter(r => {
                let kData = Object.keys(r).find(k => k.toLowerCase().trim() === 'data');
                return kData && getMesAno(r[kData]) === val;
            });

            processarDashboard(dadosFiltrados);
        }

        function processarDashboard(dados) {
            let kpis = { rec: 0, desp: 0, orc: 0 };
            let catStats = {};
            let pgtoStats = {};
            let rowsTable = [];

            dados.forEach(r => {
                // Mapeamento Din√¢mico de Colunas
                let keys = Object.keys(r);
                let kData = keys.find(k => k.toLowerCase().trim() === 'data');
                let kTipo = keys.find(k => k.toLowerCase().trim() === 'tipo');
                let kCat  = keys.find(k => k.toLowerCase().trim() === 'categoria');
                let kOrig = keys.find(k => k.toLowerCase().includes('o que') || k.toLowerCase().includes('origem'));
                let kValA = keys.find(k => k.toLowerCase().includes('ajustado'));
                let kVal  = keys.find(k => k.toLowerCase().trim() === 'valor');
                let kDesc = keys.find(k => k.toLowerCase().includes('descri'));
                let kPgto = keys.find(k => k.toLowerCase().includes('pagamento'));

                if(!kData || !kTipo) return; // Ignora linhas sem data/tipo

                let tipo = (r[kTipo] || "").toLowerCase().trim();
                let origemRaw = (r[kOrig] || "").toLowerCase().trim(); // Texto original da coluna 'o que'
                let cat = r[kCat] || "Outros";
                let desc = r[kDesc] || "-";
                let pgto = r[kPgto] || "N√£o Inf.";

                let valRaw = (kValA && r[kValA]) ? r[kValA] : r[kVal];
                let valAbs = Math.abs(cleanVal(valRaw));

                if(valAbs === 0) return;

                // --- DIAGN√ìSTICO E L√ìGICA ---
                let status = "DESCONHECIDO";
                let badgeClass = "diag-erro";
                let textoLido = origemRaw === "" ? "(Vazio)" : origemRaw;

                // 1. Verifica se √© Or√ßado (cont√©m 'orc' ou 'plan')
                if(origemRaw.includes('orc') || origemRaw.includes('or√ß') || origemRaw.includes('plan')) {
                    status = "OR√áADO";
                    badgeClass = "diag-orc";
                    
                    if(tipo === 'despesa') {
                        kpis.orc += valAbs;
                        if(!catStats[cat]) catStats[cat] = {real:0, orc:0};
                        catStats[cat].orc += valAbs;
                    }

                // 2. Verifica se √© Realizado (cont√©m 'real')
                } else if(origemRaw.includes('real')) {
                    status = "REALIZADO";
                    badgeClass = "diag-real";

                    if(tipo === 'receita') {
                        kpis.rec += valAbs;
                    } else if(tipo === 'despesa') {
                        kpis.desp += valAbs;
                        if(!catStats[cat]) catStats[cat] = {real:0, orc:0};
                        catStats[cat].real += valAbs;
                        
                        if(!pgtoStats[pgto]) pgtoStats[pgto] = 0;
                        pgtoStats[pgto] += valAbs;
                    }

                // 3. Caso n√£o bata com nenhum (Erro de Digita√ß√£o na Planilha)
                } else {
                    status = "ERRO: " + textoLido;
                    badgeClass = "diag-erro";
                }

                // Monta Linha da Tabela com Diagn√≥stico
                let badgeHtml = `<span class="diag-tag ${badgeClass}">${status}</span> <small style="color:#999">(${textoLido})</small>`;
                
                rowsTable.push([
                    r[kData],
                    badgeHtml, // Coluna Diagn√≥stico
                    tipo.toUpperCase(),
                    cat,
                    desc,
                    valAbs.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})
                ]);
            });

            // Atualiza UI
            document.getElementById('kpiReceita').innerText = kpis.rec.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('kpiDespesa').innerText = kpis.desp.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('kpiSaldo').innerText = (kpis.rec - kpis.desp).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('kpiOrcado').innerText = kpis.orc.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});

            renderizarGraficos(catStats, pgtoStats);
            renderizarTabela(rowsTable);
        }

        function renderizarGraficos(catStats, pgtoStats) {
            // Categorias
            let labels = Object.keys(catStats);
            let dReal = labels.map(c => catStats[c].real);
            let dOrc = labels.map(c => catStats[c].orc);

            if(chartCatInst) chartCatInst.destroy();
            chartCatInst = new Chart(document.getElementById('chartCategorias'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Or√ßado', data: dOrc, backgroundColor: '#f1c40f' },
                        { label: 'Realizado', data: dReal, backgroundColor: '#e74c3c' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Pagamentos
            let pLabels = Object.keys(pgtoStats);
            let pData = Object.values(pgtoStats);

            if(chartPgtoInst) chartPgtoInst.destroy();
            chartPgtoInst = new Chart(document.getElementById('chartPagamentos'), {
                type: 'doughnut',
                data: { labels: pLabels, datasets: [{ data: pData, backgroundColor: ['#3498db', '#9b59b6', '#2ecc71', '#f1c40f'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: {legend: {position:'right'}} }
            });
        }

        function renderizarTabela(rows) {
            if ($.fn.DataTable.isDataTable('#tabelaDados')) $('#tabelaDados').DataTable().destroy();
            $('#tabelaDados').DataTable({
                data: rows,
                language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json" },
                pageLength: 20,
                order: [[0, 'desc']]
            });
        }
    </script>
</body>
</html>