<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro Familiar (BI)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

    <style>
        :root { --primary: #2c3e50; --sec: #34495e; --accent: #3498db; --bg: #f4f6f9; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: #333; }
        
        /* Cabe√ßalho */
        .header { 
            background: white; padding: 20px 30px; border-radius: 12px; margin-bottom: 25px; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid var(--primary);
        }
        .header h1 { margin: 0; font-size: 22px; color: var(--primary); }
        .header small { color: #7f8c8d; font-weight: 600; }

        /* Controles */
        .controls { display: flex; gap: 10px; align-items: center; }
        .filter-badge { 
            background: #e74c3c; color: white; padding: 5px 12px; border-radius: 20px; 
            font-size: 12px; font-weight: bold; cursor: pointer; display: none; 
            align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3);
        }
        select { padding: 8px 12px; border-radius: 6px; border: 1px solid #bdc3c7; background: #fff; font-weight: 600; color: var(--primary); }
        .btn-reload { background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .btn-reload:hover { background: #2980b9; }

        /* KPIs */
        .kpi-row { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
        .kpi-card { 
            flex: 1; background: white; padding: 20px; border-radius: 10px; min-width: 160px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); text-align: center; position: relative; overflow: hidden;
        }
        .kpi-card::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; }
        .kpi-card.blue::after { background: #3498db; }
        .kpi-card.red::after { background: #e74c3c; }
        .kpi-card.green::after { background: #27ae60; }
        .kpi-card.gold::after { background: #f1c40f; }
        
        .kpi-card h3 { margin: 0 0 5px; font-size: 12px; color: #95a5a6; text-transform: uppercase; letter-spacing: 1px; }
        .kpi-card p { margin: 0; font-size: 24px; font-weight: 800; color: var(--primary); }

        /* Gr√°ficos */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .chart-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); height: 350px; position: relative; }
        .chart-title { font-size: 14px; font-weight: 700; color: var(--sec); margin-bottom: 15px; display: flex; justify-content: space-between; }
        .chart-hint { font-size: 11px; color: #bdc3c7; font-weight: normal; font-style: italic; }

        /* Tabela */
        .table-box { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        table.dataTable thead th { background-color: #f8f9fa; color: var(--sec); font-size: 13px; }
        table.dataTable tbody td { font-size: 13px; vertical-align: middle; }
        
        /* Badges de Status (O/R) */
        .badge-status { display: inline-block; width: 24px; height: 24px; line-height: 24px; text-align: center; border-radius: 50%; font-size: 11px; font-weight: bold; color: white; }
        .badge-o { background-color: #f1c40f; color: #444; } /* Or√ßado */
        .badge-r-ok { background-color: #27ae60; } /* Realizado OK/Receita */
        .badge-r-bad { background-color: #e74c3c; } /* Realizado Despesa */

        /* Loading */
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ecf0f1; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner"></div>
        <div style="font-weight:bold; color:var(--primary)">Processando Dados...</div>
    </div>

    <div class="header">
        <div>
            <h1>Painel Financeiro Familiar</h1>
            <small id="subtitulo">Vis√£o Geral</small>
        </div>
        <div class="controls">
            <div id="badgeFiltroCat" class="filter-badge" onclick="limparFiltro('cat')">Categoria: <span></span> √ó</div>
            <div id="badgeFiltroPgto" class="filter-badge" onclick="limparFiltro('pgto')">Pgto: <span></span> √ó</div>
            
            <label style="font-size:12px; font-weight:bold; color:#7f8c8d">PER√çODO:</label>
            <select id="selMes" onchange="mudarMes()"></select>
            <button class="btn-reload" onclick="location.reload()" title="Recarregar Dados">‚Üª</button>
        </div>
    </div>

    <div class="kpi-row">
        <div class="kpi-card blue">
            <h3>Entradas (Receitas)</h3>
            <p id="kpiReceita">R$ 0,00</p>
        </div>
        <div class="kpi-card red">
            <h3>Sa√≠das (Despesas)</h3>
            <p id="kpiDespesa">R$ 0,00</p>
        </div>
        <div class="kpi-card green">
            <h3>Saldo em Caixa</h3>
            <p id="kpiSaldo">R$ 0,00</p>
        </div>
        <div class="kpi-card gold">
            <h3>Or√ßamento (Teto)</h3>
            <p id="kpiOrcado">R$ 0,00</p>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-box">
            <div class="chart-title">Gastos por Categoria (Realizado vs Or√ßado) <span class="chart-hint">Clique para filtrar</span></div>
            <canvas id="chartCategorias"></canvas>
        </div>
        <div class="chart-box">
            <div class="chart-title">Formas de Pagamento <span class="chart-hint">Clique para filtrar</span></div>
            <canvas id="chartPagamentos"></canvas>
        </div>
    </div>

    <div class="charts-grid" style="grid-template-columns: 1fr 1fr;">
        <div class="chart-box" style="height: 300px;">
            <div class="chart-title">Fluxo de Caixa (Receita vs Despesa)</div>
            <canvas id="chartFluxo"></canvas>
        </div>
        <div class="chart-box" style="height: 300px;">
            <div class="chart-title">Propor√ß√£o do Or√ßamento Usado</div>
            <canvas id="chartGauge"></canvas> </div>
    </div>

    <div class="table-box">
        <div class="chart-title" style="margin-bottom:20px; font-size:16px;">üìù Detalhamento dos Lan√ßamentos</div>
        <table id="tabelaDados" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>St</th>
                    <th>Tipo</th>
                    <th>Categoria</th>
                    <th>Sub-Categoria</th>
                    <th>Descri√ß√£o</th>
                    <th>Pagamento</th>
                    <th>Valor</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO ---
        const LINK_PLANILHA = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_QrNqrn4TJZyIRm8HClxhYEU_vipX5qC_wF5sYmgbfnKPn5gl5HwNUB8SBnK_eI0U8_jiIrb7vTHE/pub?gid=1365210633&single=true&output=csv";

        // Estado da Aplica√ß√£o
        let STATE = {
            dadosBrutos: [],
            dadosMes: [],
            filtroCat: null,
            filtroPgto: null,
            charts: {} // Guarda as inst√¢ncias dos gr√°ficos
        };

        window.onload = init;

        function init() {
            Papa.parse(LINK_PLANILHA, {
                download: true, header: true, skipEmptyLines: true,
                complete: (res) => {
                    STATE.dadosBrutos = res.data;
                    document.getElementById('loading').style.display = 'none';
                    configurarFiltroDatas();
                    mudarMes(); // Inicia com o m√™s mais recente
                }
            });
        }

        // --- MANIPULA√á√ÉO DE DADOS ---
        function cleanVal(v) {
            if(!v) return 0;
            if(typeof v === 'number') return v;
            let s = v.replace("R$", "").replace(/\./g, "").replace(",", ".").trim();
            // Remove caracteres ocultos
            s = s.replace(/[^0-9.-]/g, '');
            return parseFloat(s) || 0;
        }

        function getMesAno(dataStr) {
            if(!dataStr) return "";
            // Formato DD/MM/YYYY
            if(dataStr.includes('/')) {
                let parts = dataStr.split('/');
                if(parts.length >= 3) return `${parts[2].trim()}-${parts[1].trim()}`;
            }
            // Formato ISO
            let d = new Date(dataStr);
            if(!isNaN(d)) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            return "";
        }

        function configurarFiltroDatas() {
            let meses = new Set();
            STATE.dadosBrutos.forEach(r => {
                let colData = Object.keys(r).find(k => k.toLowerCase().trim() === 'data');
                if(colData && r[colData]) {
                    let ma = getMesAno(r[colData]);
                    if(ma.length > 4) meses.add(ma);
                }
            });

            let sorted = Array.from(meses).sort().reverse();
            let sel = document.getElementById("selMes");
            
            // Op√ß√£o Todos
            let optAll = document.createElement("option"); optAll.value = "todos"; optAll.text = "Todos os Per√≠odos";
            sel.appendChild(optAll);

            sorted.forEach(m => {
                let opt = document.createElement("option");
                let [ano, mes] = m.split('-');
                let nomes = ["","Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
                opt.value = m;
                opt.text = `${nomes[parseInt(mes)]} ${ano}`;
                sel.appendChild(opt);
            });

            // Tentar selecionar m√™s atual
            let hoje = new Date();
            let atual = `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,'0')}`;
            if(sorted.includes(atual)) sel.value = atual;
            else if(sorted.length > 0) sel.value = sorted[0];
        }

        function mudarMes() {
            // Resetar filtros interativos
            STATE.filtroCat = null; 
            STATE.filtroPgto = null;
            atualizarBadgesFiltro();

            let val = document.getElementById("selMes").value;
            let txt = document.getElementById("selMes").options[document.getElementById("selMes").selectedIndex].text;
            
            document.getElementById("subtitulo").innerText = val === "todos" ? "Hist√≥rico Completo" : txt;

            if(val === "todos") {
                STATE.dadosMes = STATE.dadosBrutos;
            } else {
                STATE.dadosMes = STATE.dadosBrutos.filter(r => {
                    let colData = Object.keys(r).find(k => k.toLowerCase().trim() === 'data');
                    return colData && getMesAno(r[colData]) === val;
                });
            }

            renderizarDashboard();
        }

        // --- L√ìGICA DE FILTRAGEM (BI) ---
        function toggleFiltro(tipo, valor) {
            // Se clicar no mesmo, desativa. Se clicar em outro, troca.
            if(tipo === 'cat') {
                STATE.filtroCat = (STATE.filtroCat === valor) ? null : valor;
            } else if(tipo === 'pgto') {
                STATE.filtroPgto = (STATE.filtroPgto === valor) ? null : valor;
            }
            atualizarBadgesFiltro();
            renderizarDashboard();
        }

        function limparFiltro(tipo) {
            if(tipo === 'cat') STATE.filtroCat = null;
            if(tipo === 'pgto') STATE.filtroPgto = null;
            atualizarBadgesFiltro();
            renderizarDashboard();
        }

        function atualizarBadgesFiltro() {
            let bCat = document.getElementById('badgeFiltroCat');
            let bPgto = document.getElementById('badgeFiltroPgto');

            if(STATE.filtroCat) {
                bCat.style.display = 'flex';
                bCat.querySelector('span').innerText = STATE.filtroCat;
            } else { bCat.style.display = 'none'; }

            if(STATE.filtroPgto) {
                bPgto.style.display = 'flex';
                bPgto.querySelector('span').innerText = STATE.filtroPgto;
            } else { bPgto.style.display = 'none'; }
        }

        // --- RENDERIZA√á√ÉO ---
        function renderizarDashboard() {
            // 1. Filtrar dados com base nos cliques (BI)
            let dados = STATE.dadosMes.filter(r => {
                let matchCat = true;
                let matchPgto = true;
                
                // Mapeamento de colunas din√¢mico
                let keys = Object.keys(r);
                let colCat = keys.find(k => k.toLowerCase().trim() === 'categoria');
                let colPgto = keys.find(k => k.toLowerCase().includes('pagamento'));

                if(STATE.filtroCat && r[colCat] !== STATE.filtroCat) matchCat = false;
                if(STATE.filtroPgto && r[colPgto] !== STATE.filtroPgto) matchPgto = false;

                return matchCat && matchPgto;
            });

            // 2. Processar Agrega√ß√µes
            let kpis = { receita: 0, despesa: 0, orcado: 0 };
            let catStats = {}; // { Alimentacao: {real: 100, orc: 200} }
            let pgtoStats = {}; // { Pix: 500 }
            let linhasTabela = [];

            dados.forEach(r => {
                let keys = Object.keys(r);
                let colData = keys.find(k => k.toLowerCase().trim() === 'data');
                let colTipo = keys.find(k => k.toLowerCase().trim() === 'tipo');
                let colCat  = keys.find(k => k.toLowerCase().trim() === 'categoria');
                let colSub  = keys.find(k => k.toLowerCase().includes('sub'));
                let colDesc = keys.find(k => k.toLowerCase().includes('descri'));
                let colOrig = keys.find(k => k.toLowerCase().includes('o que') || k.toLowerCase().includes('origem'));
                let colPgto = keys.find(k => k.toLowerCase().includes('pagamento'));
                let colValA = keys.find(k => k.toLowerCase().includes('ajustado')); // Prioridade
                let colVal  = keys.find(k => k.toLowerCase().trim() === 'valor');

                if(!colData || !colTipo) return;

                let tipo = (r[colTipo] || "").toLowerCase().trim();
                let origem = (r[colOrig] || "").toLowerCase().trim();
                let cat = r[colCat] || "Outros";
                let pgto = r[colPgto] || "N√£o inf.";
                let desc = r[colDesc] || "-";

                // Valor: Tenta ajustado, sen√£o valor normal. Sempre absoluto para gr√°ficos.
                let valRaw = (colValA && r[colValA]) ? r[colValA] : r[colVal];
                let valAbs = Math.abs(cleanVal(valRaw));

                if(valAbs === 0) return;

                // L√≥gica de Neg√≥cio
                if(origem.includes('realizado')) {
                    if(tipo === 'receita') {
                        kpis.receita += valAbs;
                    } else if(tipo === 'despesa') {
                        kpis.despesa += valAbs;
                        
                        // Categorias (Realizado)
                        if(!catStats[cat]) catStats[cat] = {real:0, orc:0};
                        catStats[cat].real += valAbs;

                        // Pagamentos (Realizado)
                        if(!pgtoStats[pgto]) pgtoStats[pgto] = 0;
                        pgtoStats[pgto] += valAbs;
                    }
                } else if(origem.includes('or√ßamento')) {
                    if(tipo === 'despesa') {
                        kpis.orcado += valAbs;
                        // Categorias (Or√ßado)
                        if(!catStats[cat]) catStats[cat] = {real:0, orc:0};
                        catStats[cat].orc += valAbs;
                    }
                }

                // Tabela
                // Badge O ou R
                let badge = "";
                if(origem.includes('or√ßamento')) badge = '<span class="badge-status badge-o" title="Or√ßado">O</span>';
                else if(tipo === 'receita') badge = '<span class="badge-status badge-r-ok" title="Receita Realizada">R</span>';
                else badge = '<span class="badge-status badge-r-bad" title="Despesa Realizada">R</span>';

                linhasTabela.push([
                    r[colData],
                    badge,
                    tipo.toUpperCase(),
                    cat,
                    r[colSub] || "",
                    desc, // AQUI EST√Å A DESCRI√á√ÉO
                    pgto,
                    valAbs.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})
                ]);
            });

            // 3. Atualizar UI
            atualizarKPIs(kpis);
            atualizarGraficos(catStats, pgtoStats, kpis);
            atualizarTabela(linhasTabela);
        }

        function atualizarKPIs(k) {
            document.getElementById('kpiReceita').innerText = k.receita.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('kpiDespesa').innerText = k.despesa.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('kpiOrcado').innerText = k.orcado.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            
            let saldo = k.receita - k.despesa;
            let elSaldo = document.getElementById('kpiSaldo');
            elSaldo.innerText = saldo.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            elSaldo.style.color = saldo >= 0 ? '#27ae60' : '#c0392b';
        }

        function atualizarGraficos(catStats, pgtoStats, kpis) {
            // Chart Categorias
            let labelsCat = Object.keys(catStats);
            let dataReal = labelsCat.map(c => catStats[c].real);
            let dataOrc = labelsCat.map(c => catStats[c].orc);

            if(STATE.charts.cat) STATE.charts.cat.destroy();
            STATE.charts.cat = new Chart(document.getElementById('chartCategorias'), {
                type: 'bar',
                data: {
                    labels: labelsCat,
                    datasets: [
                        { label: 'Or√ßado', data: dataOrc, backgroundColor: '#f1c40f', opacity: 0.7 },
                        { label: 'Realizado', data: dataReal, backgroundColor: '#e74c3c' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onClick: (evt, els) => {
                        if(els.length > 0) toggleFiltro('cat', labelsCat[els[0].index]);
                    },
                    scales: { x: { stacked: false }, y: { beginAtZero: true } }
                }
            });

            // Chart Pagamentos
            let labelsPgto = Object.keys(pgtoStats);
            let dataPgto = Object.values(pgtoStats);
            
            if(STATE.charts.pgto) STATE.charts.pgto.destroy();
            STATE.charts.pgto = new Chart(document.getElementById('chartPagamentos'), {
                type: 'doughnut',
                data: {
                    labels: labelsPgto,
                    datasets: [{
                        data: dataPgto,
                        backgroundColor: ['#3498db', '#9b59b6', '#2ecc71', '#f1c40f', '#e67e22', '#1abc9c', '#34495e']
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onClick: (evt, els) => {
                        if(els.length > 0) toggleFiltro('pgto', labelsPgto[els[0].index]);
                    },
                    plugins: { legend: { position: 'right' } }
                }
            });

            // Chart Fluxo
            if(STATE.charts.fluxo) STATE.charts.fluxo.destroy();
            STATE.charts.fluxo = new Chart(document.getElementById('chartFluxo'), {
                type: 'bar',
                data: {
                    labels: ['Entradas', 'Sa√≠das'],
                    datasets: [{
                        label: 'Total',
                        data: [kpis.receita, kpis.despesa],
                        backgroundColor: ['#27ae60', '#c0392b'],
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // Chart Gauge (Simulado) - % do Or√ßamento Consumido
            let percent = kpis.orcado > 0 ? (kpis.despesa / kpis.orcado) * 100 : 0;
            let restante = 100 - percent;
            if(restante < 0) restante = 0; // Estourou

            if(STATE.charts.gauge) STATE.charts.gauge.destroy();
            STATE.charts.gauge = new Chart(document.getElementById('chartGauge'), {
                type: 'doughnut',
                data: {
                    labels: ['Usado', 'Dispon√≠vel'],
                    datasets: [{
                        data: [percent, restante],
                        backgroundColor: [percent > 100 ? '#c0392b' : '#3498db', '#ecf0f1'],
                        circumference: 180, rotation: 270
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        title: { display: true, text: percent.toFixed(1) + '% Consumido', position: 'bottom' }
                    }
                }
            });
        }

        function atualizarTabela(rows) {
            if ($.fn.DataTable.isDataTable('#tabelaDados')) {
                $('#tabelaDados').DataTable().destroy();
            }
            $('#tabelaDados').DataTable({
                data: rows,
                language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json" },
                pageLength: 5,
                order: [[0, 'desc']], // Ordenar por Data
                columnDefs: [
                    { className: "dt-center", targets: [1] }, // Centraliza Badge
                    { width: "25%", targets: 5 } // Largura maior para Descri√ß√£o
                ]
            });
        }
    </script>
</body>
</html>