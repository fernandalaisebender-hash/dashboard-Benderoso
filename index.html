<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro Familiar</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; margin: 0; padding: 20px; }
        
        .header { 
            background: #2c3e50; 
            color: white; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 6px;
        }
        
        select {
            padding: 8px;
            border-radius: 4px;
            border: none;
            font-size: 16px;
            cursor: pointer;
            background-color: #fff;
            color: #333;
            font-weight: bold;
        }

        .btn-update { background-color: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-update:hover { background-color: #219150; }

        .kpi-container { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .kpi-card { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; min-width: 200px; }
        .kpi-card h3 { margin: 0 0 10px 0; color: #7f8c8d; font-size: 14px; }
        .kpi-card p { font-size: 24px; font-weight: bold; margin: 0; color: #2c3e50; }
        
        .charts-container { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .chart-box { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); min-width: 400px; height: 400px; }
        .table-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .positivo { color: #27ae60 !important; }
        .negativo { color: #c0392b !important; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1 style="margin:0;">ðŸ“Š Painel Financeiro</h1>
            <small id="subtituloData">Carregando dados...</small>
        </div>
        
        <div class="filter-group">
            <label>ðŸ“… Analisar MÃªs:</label>
            <select id="selMes" onchange="aplicarFiltro()">
                <option value="todos">Todos os PerÃ­odos</option>
            </select>
            <button class="btn-update" onclick="carregarDados()">ðŸ”„ Atualizar</button>
        </div>
    </div>

    <div class="kpi-container">
        <div class="kpi-card">
            <h3>OrÃ§amento Planejado</h3>
            <p id="kpiOrcado">...</p>
        </div>
        <div class="kpi-card">
            <h3>Total Gasto (Realizado)</h3>
            <p id="kpiRealizado">...</p>
        </div>
        <div class="kpi-card">
            <h3>Saldo do PerÃ­odo</h3>
            <p id="kpiSaldo">...</p>
        </div>
        <div class="kpi-card">
            <h3>Status</h3>
            <p id="kpiStatus">...</p>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-box">
            <canvas id="chartComparativo"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="chartCategorias"></canvas>
        </div>
    </div>

    <div class="table-container">
        <h3>LanÃ§amentos do PerÃ­odo (Base: Valor Ajustado)</h3>
        <table id="tabelaDados" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Categoria</th>
                    <th>Sub-Categoria</th>
                    <th>Tipo</th>
                    <th>Origem</th>
                    <th>Valor Ajustado</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // SEU LINK FIXO:
        const LINK_PLANILHA = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_QrNqrn4TJZyIRm8HClxhYEU_vipX5qC_wF5sYmgbfnKPn5gl5HwNUB8SBnK_eI0U8_jiIrb7vTHE/pub?gid=1365210633&single=true&output=csv";

        let chartComparativoInstancia = null;
        let chartCategoriasInstancia = null;
        let DADOS_GLOBAIS = [];

        window.onload = carregarDados;

        function limparValor(valorStr) {
            if (!valorStr) return 0;
            if (typeof valorStr === 'number') return valorStr;
            let limpo = valorStr.replace("R$", "").replace(/\./g, "").replace(",", ".").trim();
            return parseFloat(limpo) || 0;
        }

        function extrairMesAno(dataStr) {
            if (!dataStr) return "";
            let partes = dataStr.split('/');
            if (partes.length === 3) {
                return partes[2] + "-" + partes[1]; 
            }
            let dataObj = new Date(dataStr);
            if (!isNaN(dataObj)) {
                let mes = (dataObj.getMonth() + 1).toString().padStart(2, '0');
                return dataObj.getFullYear() + "-" + mes;
            }
            return "";
        }

        function formatarMesAnoLegivel(chaveAnoMes) {
            if (!chaveAnoMes) return "Data InvÃ¡lida";
            let [ano, mes] = chaveAnoMes.split('-');
            const nomes = ["", "Janeiro", "Fevereiro", "MarÃ§o", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            return `${nomes[parseInt(mes)]} de ${ano}`;
        }

        function carregarDados() {
            Papa.parse(LINK_PLANILHA, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if(results.data.length === 0) return;
                    DADOS_GLOBAIS = results.data;
                    popularFiltroMeses();
                    aplicarFiltro();
                },
                error: function(err) {
                    console.error(err);
                    alert("Erro ao carregar dados.");
                }
            });
        }

        function popularFiltroMeses() {
            let mesesUnicos = new Set();
            DADOS_GLOBAIS.forEach(row => {
                let chave = extrairMesAno(row['Data']);
                if (chave && chave.length > 4) mesesUnicos.add(chave);
            });
            
            // Ordena os meses do mais recente para o mais antigo
            let arrayMeses = Array.from(mesesUnicos).sort().reverse();
            
            let select = document.getElementById("selMes");
            select.innerHTML = '<option value="todos">Todos os PerÃ­odos</option>';
            
            arrayMeses.forEach(mesChave => {
                let option = document.createElement("option");
                option.value = mesChave;
                option.text = formatarMesAnoLegivel(mesChave);
                select.appendChild(option);
            });

            // --- LÃ“GICA DO MÃŠS ATUAL ---
            let dataHoje = new Date();
            let mesAtual = (dataHoje.getMonth() + 1).toString().padStart(2, '0'); // ex: "01"
            let anoAtual = dataHoje.getFullYear(); // ex: 2026
            let chaveAtual = `${anoAtual}-${mesAtual}`; // ex: "2026-01"

            // Tenta selecionar o mÃªs atual se ele existir na lista
            if (arrayMeses.includes(chaveAtual)) {
                select.value = chaveAtual;
            } else if (arrayMeses.length > 0) {
                // Se nÃ£o achar o atual (ex: virou o mÃªs e nÃ£o tem dado ainda), pega o mais recente da lista
                select.value = arrayMeses[0];
            }
        }

        function aplicarFiltro() {
            let filtro = document.getElementById("selMes").value;
            let dadosFiltrados;

            if (filtro === "todos") {
                dadosFiltrados = DADOS_GLOBAIS;
                document.getElementById("subtituloData").innerText = "Visualizando todo o histÃ³rico";
            } else {
                dadosFiltrados = DADOS_GLOBAIS.filter(row => {
                    return extrairMesAno(row['Data']) === filtro;
                });
                document.getElementById("subtituloData").innerText = "Visualizando: " + formatarMesAnoLegivel(filtro);
            }

            processarEExibir(dadosFiltrados);
        }

        function processarEExibir(dados) {
            let totalOrcado = 0;
            let totalRealizado = 0;
            let categorias = {}; 
            let tabelaLinhas = [];

            dados.forEach(row => {
                let categoria = row['Categoria'];
                let subCategoria = row['Sub-Categoria'];
                let tipo = row['Tipo']; 
                let origem = row['o que']; 
                let data = row['Data'];
                let valorStr = row['Valor ajustado'] || row['Valor']; 

                if (!categoria || !origem) return;

                let valor = limparValor(valorStr); 
                let origemNorm = origem.toLowerCase().trim();
                let tipoNorm = tipo ? tipo.toLowerCase().trim() : "";

                if (!categorias[categoria]) categorias[categoria] = { orcado: 0, realizado: 0 };

                if (origemNorm.includes('orÃ§amento')) {
                    if (tipoNorm === 'despesa') {
                        let valorAbsoluto = Math.abs(valor);
                        categorias[categoria].orcado += valorAbsoluto;
                        totalOrcado += valorAbsoluto;
                    }
                } else if (origemNorm.includes('realizado')) {
                    if (tipoNorm === 'despesa') {
                        let valorAbsoluto = Math.abs(valor);
                        categorias[categoria].realizado += valorAbsoluto;
                        totalRealizado += valorAbsoluto;
                    }
                }

                tabelaLinhas.push([
                    data, categoria, subCategoria, tipo, origem, 
                    valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
                ]);
            });

            atualizarKPIs(totalOrcado, totalRealizado);
            atualizarGraficos(categorias);
            atualizarTabela(tabelaLinhas);
        }

        function atualizarKPIs(orcado, realizado) {
            document.getElementById('kpiOrcado').innerText = orcado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('kpiRealizado').innerText = realizado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            let saldo = orcado - realizado;
            let elSaldo = document.getElementById('kpiSaldo');
            elSaldo.innerText = saldo.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            let elStatus = document.getElementById('kpiStatus');
            if (saldo >= 0) {
                elSaldo.className = 'positivo';
                elStatus.innerText = "Dentro da Meta";
                elStatus.className = 'positivo';
            } else {
                elSaldo.className = 'negativo';
                elStatus.innerText = "Estourou o OrÃ§amento";
                elStatus.className = 'negativo';
            }
        }

        function atualizarGraficos(dadosCategorias) {
            const labels = Object.keys(dadosCategorias);
            const dadosOrcado = labels.map(cat => dadosCategorias[cat].orcado);
            const dadosRealizado = labels.map(cat => dadosCategorias[cat].realizado);

            const ctx1 = document.getElementById('chartComparativo').getContext('2d');
            if (chartComparativoInstancia) chartComparativoInstancia.destroy();
            
            chartComparativoInstancia = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'OrÃ§ado', data: dadosOrcado, backgroundColor: '#95a5a6', borderRadius: 4 },
                        { label: 'Realizado', data: dadosRealizado, backgroundColor: '#c0392b', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { title: { display: true, text: 'OrÃ§ado vs Realizado (Por Categoria)' } }
                }
            });

            const ctx2 = document.getElementById('chartCategorias').getContext('2d');
            if (chartCategoriasInstancia) chartCategoriasInstancia.destroy();

            let labelsRosca = [];
            let dadosRosca = [];
            labels.forEach((label, index) => {
                if (dadosRealizado[index] > 0) {
                    labelsRosca.push(label);
                    dadosRosca.push(dadosRealizado[index]);
                }
            });

            chartCategoriasInstancia = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: labelsRosca,
                    datasets: [{
                        data: dadosRosca,
                        backgroundColor: ['#e74c3c', '#8e44ad', '#3498db', '#f1c40f', '#2ecc71', '#34495e', '#e67e22', '#16a085']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        title: { display: true, text: 'DistribuiÃ§Ã£o dos Gastos' },
                        legend: { position: 'right' }
                    }
                }
            });
        }

        function atualizarTabela(dataset) {
            if ($.fn.DataTable.isDataTable('#tabelaDados')) {
                $('#tabelaDados').DataTable().destroy();
            }
            $('#tabelaDados').DataTable({
                data: dataset,
                language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json" },
                pageLength: 10,
                order: [[0, 'desc']] 
            });
        }
    </script>
</body>
</html>