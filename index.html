<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro (V15.0 - Ordenado)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

    <style>
        :root { --primary: #2c3e50; --bg: #f4f6f9; --accent: #3498db; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: #333; }
        
        .header { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid var(--primary); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        .controls { display: flex; gap: 10px; align-items: center; }
        .filter-badge { 
            background: #e74c3c; color: white; padding: 6px 14px; border-radius: 20px; 
            font-size: 12px; font-weight: bold; cursor: pointer; display: none; 
            align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3); transition: 0.2s;
        }
        .filter-badge:hover { background: #c0392b; transform: translateY(-1px); }

        .btn-reload { padding: 8px 15px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        
        .kpi-row { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .kpi-card { flex: 1; background: white; padding: 20px; border-radius: 10px; text-align: center; min-width: 150px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; }
        .kpi-card::after { content:''; position:absolute; top:0; left:0; width:100%; height:4px; }
        .border-blue::after { background: #3498db; }
        .border-red::after { background: #e74c3c; }
        .border-green::after { background: #27ae60; }
        .border-gold::after { background: #f1c40f; }
        
        .kpi-card h3 { margin: 0 0 5px; font-size: 11px; color: #95a5a6; text-transform: uppercase; letter-spacing: 1px; }
        .kpi-card p { margin: 0; font-size: 24px; font-weight: 800; color: var(--primary); }
        .kpi-info { font-size: 10px; color: #bdc3c7; margin-top: 5px; }

        /* Grids */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-box { background: white; padding: 20px; border-radius: 10px; height: 350px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); position: relative; }
        .chart-box-large { background: white; padding: 20px; border-radius: 10px; height: 450px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); position: relative; margin-bottom: 20px; }

        /* Layout Espec√≠fico para Fluxo (Full Width) */
        .chart-full-row { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-box-wide { background: white; padding: 20px; border-radius: 10px; height: 300px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); position: relative; }

        .chart-title { font-size: 14px; font-weight: 700; color: #34495e; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .chart-hint { font-size: 11px; color: #bdc3c7; font-weight: normal; font-style: italic; }

        .table-box { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }

        .status-badge { display: inline-flex; justify-content: center; align-items: center; width: 24px; height: 24px; border-radius: 50%; font-size: 12px; font-weight: 900; color: white; }
        .status-o { background-color: #f1c40f; color: #555; } 
        .status-r { background-color: #2980b9; } 

        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ecf0f1; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner"></div>
        <div style="font-weight:bold; color:var(--primary)">Atualizando Dashboard...</div>
    </div>

    <div class="header">
        <div>
            <h1 style="margin:0; font-size:22px;">Painel Financeiro</h1>
            <small id="subtitulo">Vis√£o Geral</small>
        </div>
        <div class="controls">
            <div id="badgeFiltroCat" class="filter-badge" onclick="limparFiltro('cat')">Categoria: <span></span> √ó</div>
            <div id="badgeFiltroPgto" class="filter-badge" onclick="limparFiltro('pgto')">Pgto: <span></span> √ó</div>
            <label style="font-weight:bold; font-size:12px; color:#95a5a6">PER√çODO:</label>
            <select id="selMes" onchange="mudarMes()" style="padding:6px; border-radius:4px; border:1px solid #ccc;"></select>
            <button class="btn-reload" onclick="location.reload()">Atualizar</button>
        </div>
    </div>

    <div class="kpi-row">
        <div class="kpi-card border-blue">
            <h3>Entradas (Receitas)</h3>
            <p id="kpiReceita">R$ 0,00</p>
            <div class="kpi-info">M√™s Selecionado</div>
        </div>
        <div class="kpi-card border-red">
            <h3>Despesas Totais</h3>
            <p id="kpiDespesa">R$ 0,00</p>
            <div class="kpi-info">Inclui Cart√£o de Cr√©dito</div>
        </div>
        <div class="kpi-card border-green">
            <h3>Saldo Dispon√≠vel</h3>
            <p id="kpiSaldo">R$ 0,00</p>
            <div class="kpi-info">Caixa (Sem Cr√©dito)</div>
        </div>
        <div class="kpi-card border-gold">
            <h3>Or√ßamento (O)</h3>
            <p id="kpiOrcado">R$ 0,00</p>
            <div class="kpi-info">Planejado do M√™s</div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-box">
            <div class="chart-title">Or√ßado vs Realizado (Ordenado por Maior Gasto)</div>
            <canvas id="chartCategorias"></canvas>
        </div>
        <div class="chart-box">
            <div class="chart-title">Formas de Pagamento</div>
            <canvas id="chartPagamentos"></canvas>
        </div>
    </div>

    <div class="chart-full-row">
        <div class="chart-box-wide">
            <div class="chart-title">Fluxo de Caixa (Entradas vs Sa√≠das Efetivas)</div>
            <canvas id="chartFluxo"></canvas>
        </div>
    </div>

    <div class="chart-box-large">
        <div class="chart-title">üèÜ Ranking Acumulado no Ano <span class="chart-hint" id="anoAcumuladoHint">(YTD)</span></div>
        <canvas id="chartAcumulado"></canvas>
    </div>

    <div class="table-box">
        <div class="chart-title" style="margin-bottom:15px">üìù Detalhamento dos Lan√ßamentos</div>
        <table id="tabelaDados" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>St</th>
                    <th>Tipo</th>
                    <th>Categoria</th>
                    <th>Sub-Cat</th>
                    <th>Descri√ß√£o</th>
                    <th>Pgto</th>
                    <th>Valor</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const LINK_PLANILHA = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_QrNqrn4TJZyIRm8HClxhYEU_vipX5qC_wF5sYmgbfnKPn5gl5HwNUB8SBnK_eI0U8_jiIrb7vTHE/pub?gid=1365210633&single=true&output=csv";

        let STATE = { dadosBrutos: [], dadosMes: [], filtroCat: null, filtroPgto: null, charts: {} };

        window.onload = function() {
            Papa.parse(LINK_PLANILHA, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    STATE.dadosBrutos = results.data;
                    document.getElementById('loading').style.display = 'none';
                    configurarFiltroDatas();
                    mudarMes();
                }
            });
        };

        function cleanVal(v) {
            if(!v) return 0;
            if(typeof v === 'number') return v;
            let s = v.toString().replace("R$", "").replace(/\./g, "").replace(",", ".").trim();
            s = s.replace(/[^0-9.-]/g, ''); 
            return parseFloat(s) || 0;
        }

        function getMesAno(dataStr) {
            if(!dataStr) return "";
            if(dataStr.includes('/')) {
                let parts = dataStr.split('/');
                if(parts.length >= 3) return `${parts[2].trim()}-${parts[1].trim()}`;
            }
            let d = new Date(dataStr);
            if(!isNaN(d)) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            return "";
        }

        function configurarFiltroDatas() {
            let meses = new Set();
            STATE.dadosBrutos.forEach(r => {
                let kData = Object.keys(r).find(k => k.toLowerCase().trim() === 'data');
                if(kData && r[kData]) {
                    let ma = getMesAno(r[kData]);
                    if(ma.length > 4) meses.add(ma);
                }
            });
            let sorted = Array.from(meses).sort().reverse();
            let sel = document.getElementById("selMes");
            
            let optAll = document.createElement("option"); optAll.value = "todos"; optAll.text = "Todos os Per√≠odos";
            sel.appendChild(optAll);

            sorted.forEach(m => {
                let opt = document.createElement("option");
                let [ano, mes] = m.split('-');
                let nomes = ["","Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
                opt.value = m;
                opt.text = `${nomes[parseInt(mes)]} ${ano}`;
                sel.appendChild(opt);
            });
            
            let hoje = new Date();
            let atual = `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,'0')}`;
            if(sorted.includes(atual)) sel.value = atual;
            else if(sorted.length > 0) sel.value = sorted[0];
        }

        function mudarMes() {
            STATE.filtroCat = null; STATE.filtroPgto = null;
            atualizarBadges();
            let val = document.getElementById("selMes").value;
            let txt = document.getElementById("selMes").options[document.getElementById("selMes").selectedIndex].text;
            document.getElementById("subtitulo").innerText = val === "todos" ? "Hist√≥rico Completo" : txt;
            
            if(val === "todos") STATE.dadosMes = STATE.dadosBrutos;
            else STATE.dadosMes = STATE.dadosBrutos.filter(r => {
                let kData = Object.keys(r).find(k => k.toLowerCase().trim() === 'data');
                return kData && getMesAno(r[kData]) === val;
            });

            processarDashboard();
            gerarAnaliseAnualYTD(val);
        }

        function toggleFiltro(tipo, valor) {
            if(tipo === 'cat') STATE.filtroCat = (STATE.filtroCat === valor) ? null : valor;
            else if(tipo === 'pgto') STATE.filtroPgto = (STATE.filtroPgto === valor) ? null : valor;
            atualizarBadges();
            processarDashboard();
        }

        function limparFiltro(tipo) {
            if(tipo === 'cat') STATE.filtroCat = null;
            if(tipo === 'pgto') STATE.filtroPgto = null;
            atualizarBadges();
            processarDashboard();
        }

        function atualizarBadges() {
            let bCat = document.getElementById('badgeFiltroCat');
            let bPgto = document.getElementById('badgeFiltroPgto');
            bCat.style.display = STATE.filtroCat ? 'flex' : 'none';
            if(STATE.filtroCat) bCat.querySelector('span').innerText = STATE.filtroCat;
            bPgto.style.display = STATE.filtroPgto ? 'flex' : 'none';
            if(STATE.filtroPgto) bPgto.querySelector('span').innerText = STATE.filtroPgto;
        }

        function processarDashboard() {
            let dadosFiltrados = STATE.dadosMes.filter(r => {
                let keys = Object.keys(r);
                let colCat = keys.find(k => k.toLowerCase().trim() === 'categoria');
                let colPgto = keys.find(k => k.toLowerCase().includes('pagamento'));
                let matchCat = STATE.filtroCat ? (r[colCat] === STATE.filtroCat) : true;
                let matchPgto = STATE.filtroPgto ? (r[colPgto] === STATE.filtroPgto) : true;
                return matchCat && matchPgto;
            });

            let kpis = { rec: 0, despTotal: 0, despCaixa: 0, orc: 0 };
            let catStats = {};
            let pgtoStats = {};
            let rowsTable = [];

            dadosFiltrados.forEach(r => {
                let keys = Object.keys(r);
                let colData = keys.find(k => k.toLowerCase().trim() === 'data');
                let colTipo = keys.find(k => k.toLowerCase().trim() === 'tipo');
                let colCat  = keys.find(k => k.toLowerCase().trim() === 'categoria');
                let colSub  = keys.find(k => k.toLowerCase().includes('sub'));
                let colOrig = keys.find(k => k.toLowerCase().includes('o que') || k.toLowerCase().includes('origem'));
                let colValA = keys.find(k => k.toLowerCase().includes('ajustado'));
                let colVal  = keys.find(k => k.toLowerCase().trim() === 'valor');
                let colDesc = keys.find(k => k.toLowerCase().includes('descri'));
                let colPgto = keys.find(k => k.toLowerCase().includes('pagamento'));

                if(!colData || !colTipo) return;

                let tipo = (r[colTipo] || "").toLowerCase().trim();
                let origemRaw = (r[colOrig] || "").toLowerCase().trim();
                let cat = r[colCat] || "Outros";
                let desc = r[colDesc] || "-";
                let pgto = (r[colPgto] || "N√£o Inf.").trim();
                let valRaw = (colValA && r[colValA]) ? r[colValA] : r[colVal];
                let valAbs = Math.abs(cleanVal(valRaw));

                if(valAbs === 0) return;

                let isRealizado = origemRaw.includes('realiz'); 
                let isOrcamento = !isRealizado; 
                let isCredito = pgto.toLowerCase().includes('cr√©dito') || pgto.toLowerCase().includes('credito') || pgto.toLowerCase().includes('master') || pgto.toLowerCase().includes('visa');

                if(isOrcamento) {
                    if(tipo === 'despesa') {
                        kpis.orc += valAbs;
                        if(!catStats[cat]) catStats[cat] = {real:0, orc:0};
                        catStats[cat].orc += valAbs;
                    }
                } else {
                    if(tipo === 'receita') {
                        kpis.rec += valAbs;
                    } else if(tipo === 'despesa') {
                        kpis.despTotal += valAbs; 
                        if(!isCredito) kpis.despCaixa += valAbs;
                        if(!catStats[cat]) catStats[cat] = {real:0, orc:0};
                        catStats[cat].real += valAbs;
                        if(!pgtoStats[pgto]) pgtoStats[pgto] = 0;
                        pgtoStats[pgto] += valAbs;
                    }
                }

                let badge = isOrcamento 
                    ? '<span class="status-badge status-o" title="Or√ßado">O</span>' 
                    : '<span class="status-badge status-r" title="Realizado">R</span>';

                rowsTable.push([
                    r[colData],
                    badge,
                    tipo.toUpperCase(),
                    cat,
                    r[colSub]||"",
                    desc,
                    pgto,
                    valAbs.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})
                ]);
            });

            let saldo = kpis.rec - kpis.despCaixa; 

            document.getElementById('kpiReceita').innerText = kpis.rec.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('kpiDespesa').innerText = kpis.despTotal.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('kpiSaldo').innerText = saldo.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('kpiOrcado').innerText = kpis.orc.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('kpiSaldo').style.color = saldo >= 0 ? '#27ae60' : '#e74c3c';

            renderizarGraficos(catStats, pgtoStats, kpis);
            renderizarTabela(rowsTable);
        }

        function gerarAnaliseAnualYTD(mesSelecionado) {
            let anoLimite = 0;
            let mesLimite = 0;
            
            if(mesSelecionado === "todos") {
                let hoje = new Date();
                anoLimite = hoje.getFullYear();
                mesLimite = 12;
                document.getElementById('anoAcumuladoHint').innerText = `(Tudo de ${anoLimite})`;
            } else {
                let parts = mesSelecionado.split('-');
                anoLimite = parseInt(parts[0]);
                mesLimite = parseInt(parts[1]);
                let nomes = ["","Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
                document.getElementById('anoAcumuladoHint').innerText = `(Jan a ${nomes[mesLimite]} de ${anoLimite})`;
            }

            let catAcumulado = {};
            STATE.dadosBrutos.forEach(r => {
                let keys = Object.keys(r);
                let colData = keys.find(k => k.toLowerCase().trim() === 'data');
                let colTipo = keys.find(k => k.toLowerCase().trim() === 'tipo');
                let colCat  = keys.find(k => k.toLowerCase().trim() === 'categoria');
                let colOrig = keys.find(k => k.toLowerCase().includes('o que') || k.toLowerCase().includes('origem'));
                let colValA = keys.find(k => k.toLowerCase().includes('ajustado'));
                let colVal  = keys.find(k => k.toLowerCase().trim() === 'valor');

                if(!colData || !r[colData]) return;
                
                let rAno = 0, rMes = 0;
                if(r[colData].includes('/')) {
                    let p = r[colData].split('/');
                    rAno = parseInt(p[2]); rMes = parseInt(p[1]);
                } else { 
                    let d = new Date(r[colData]); 
                    if(!isNaN(d)) { rAno = d.getFullYear(); rMes = d.getMonth()+1; }
                }
                
                if(rAno === anoLimite && rMes <= mesLimite) {
                    let origemRaw = (r[colOrig] || "").toLowerCase();
                    let tipo = (r[colTipo] || "").toLowerCase().trim();
                    let isRealizado = origemRaw.includes('realiz');

                    if(isRealizado && tipo === 'despesa') {
                        let cat = r[colCat] || "Outros";
                        let valRaw = (colValA && r[colValA]) ? r[colValA] : r[colVal];
                        let valAbs = Math.abs(cleanVal(valRaw));
                        
                        if(!catAcumulado[cat]) catAcumulado[cat] = 0;
                        catAcumulado[cat] += valAbs;
                    }
                }
            });

            // Ordena√ß√£o (YTD)
            let sortedCats = Object.entries(catAcumulado).sort((a,b) => b[1] - a[1]);
            let labels = sortedCats.map(x => x[0]);
            let data = sortedCats.map(x => x[1]);

            if(STATE.charts.acumulado) STATE.charts.acumulado.destroy();
            STATE.charts.acumulado = new Chart(document.getElementById('chartAcumulado'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Gasto Acumulado (YTD)',
                        data: data,
                        backgroundColor: '#e74c3c',
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y', 
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderizarGraficos(catStats, pgtoStats, kpis) {
            // ORDENA√á√ÉO: Maior Gasto Realizado Primeiro
            let sortedEntries = Object.entries(catStats)
                .map(([key, val]) => ({ key, ...val }))
                .sort((a, b) => b.real - a.real); // Ordena por gasto realizado (Desc)

            let labelsCat = sortedEntries.map(e => e.key);
            let dReal = sortedEntries.map(e => e.real);
            let dOrc = sortedEntries.map(e => e.orc);

            // Gr√°fico 1: Categorias (Ordenado)
            if(STATE.charts.cat) STATE.charts.cat.destroy();
            STATE.charts.cat = new Chart(document.getElementById('chartCategorias'), {
                type: 'bar',
                data: {
                    labels: labelsCat,
                    datasets: [
                        { label: 'Realizado (Gasto)', data: dReal, backgroundColor: '#e74c3c' },
                        { label: 'Planejado', data: dOrc, backgroundColor: '#f1c40f', opacity: 0.7 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onClick: (evt, els) => { if(els.length > 0) toggleFiltro('cat', labelsCat[els[0].index]); }
                }
            });

            // Gr√°fico 2: Pagamentos
            let labelsPgto = Object.keys(pgtoStats);
            let dPgto = Object.values(pgtoStats);
            if(STATE.charts.pgto) STATE.charts.pgto.destroy();
            STATE.charts.pgto = new Chart(document.getElementById('chartPagamentos'), {
                type: 'doughnut',
                data: { labels: labelsPgto, datasets: [{ data: dPgto, backgroundColor: ['#3498db', '#9b59b6', '#2ecc71', '#f1c40f', '#e67e22', '#1abc9c'] }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onClick: (evt, els) => { if(els.length > 0) toggleFiltro('pgto', labelsPgto[els[0].index]); },
                    plugins: { legend: { position: 'right' } }
                }
            });

            // Gr√°fico 3: Fluxo de Caixa (Full Width)
            if(STATE.charts.fluxo) STATE.charts.fluxo.destroy();
            STATE.charts.fluxo = new Chart(document.getElementById('chartFluxo'), {
                type: 'bar',
                data: {
                    labels: ['Entradas', 'Sa√≠das (Caixa)'],
                    datasets: [{ label: 'Total', data: [kpis.rec, kpis.despCaixa], backgroundColor: ['#27ae60', '#e74c3c'], borderRadius: 5 }]
                },
                options: { 
                    indexAxis: 'y', // Barra Horizontal para diferenciar
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false } } 
                }
            });
        }

        function renderizarTabela(rows) {
            if ($.fn.DataTable.isDataTable('#tabelaDados')) $('#tabelaDados').DataTable().destroy();
            $('#tabelaDados').DataTable({
                data: rows,
                language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json" },
                pageLength: 10,
                order: [[0, 'desc']],
                columnDefs: [ { className: "dt-center", targets: [1] } ]
            });
        }
    </script>
</body>
</html>