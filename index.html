<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro Familiar</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; margin: 0; padding: 20px; }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        /* BotÃ£o de atualizar agora fica no topo, discreto */
        .btn-update { background-color: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-update:hover { background-color: #219150; }

        .kpi-container { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .kpi-card { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; min-width: 200px; }
        .kpi-card h3 { margin: 0 0 10px 0; color: #7f8c8d; font-size: 14px; }
        .kpi-card p { font-size: 24px; font-weight: bold; margin: 0; color: #2c3e50; }
        
        .charts-container { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .chart-box { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); min-width: 400px; height: 400px; }
        .table-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .positivo { color: #27ae60 !important; }
        .negativo { color: #c0392b !important; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1 style="margin:0;">ðŸ“Š Painel Financeiro</h1>
            <small>Dados conectados ao Google Drive</small>
        </div>
        <button class="btn-update" onclick="carregarDados()">ðŸ”„ Atualizar Dados</button>
    </div>

    <div class="kpi-container">
        <div class="kpi-card">
            <h3>Total OrÃ§ado (MÃªs)</h3>
            <p id="kpiOrcado">Carregando...</p>
        </div>
        <div class="kpi-card">
            <h3>Total Gasto (Realizado)</h3>
            <p id="kpiRealizado">Carregando...</p>
        </div>
        <div class="kpi-card">
            <h3>Saldo Restante</h3>
            <p id="kpiSaldo">...</p>
        </div>
        <div class="kpi-card">
            <h3>Status</h3>
            <p id="kpiStatus">...</p>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-box">
            <canvas id="chartComparativo"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="chartCategorias"></canvas>
        </div>
    </div>

    <div class="table-container">
        <h3>Detalhamento dos LanÃ§amentos</h3>
        <table id="tabelaDados" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Categoria</th>
                    <th>Sub-Categoria</th>
                    <th>Tipo</th>
                    <th>Origem</th>
                    <th>Valor</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // SEU LINK JÃ ESTÃ CONFIGURADO AQUI:
        const LINK_PLANILHA = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_QrNqrn4TJZyIRm8HClxhYEU_vipX5qC_wF5sYmgbfnKPn5gl5HwNUB8SBnK_eI0U8_jiIrb7vTHE/pub?gid=1365210633&single=true&output=csv";

        let chartComparativoInstancia = null;
        let chartCategoriasInstancia = null;

        // Inicia o carregamento assim que a pÃ¡gina abre
        window.onload = carregarDados;

        function limparValor(valorStr) {
            if (!valorStr) return 0;
            if (typeof valorStr === 'number') return valorStr;
            let limpo = valorStr.replace("R$", "").replace(/\./g, "").replace(",", ".").trim();
            return parseFloat(limpo) || 0;
        }

        function carregarDados() {
            console.log("Iniciando carregamento...");
            
            Papa.parse(LINK_PLANILHA, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log("Dados recebidos!", results.data);
                    if(results.data.length === 0) {
                        alert("A planilha parece estar vazia ou o link nÃ£o retornou dados.");
                        return;
                    }
                    processarDados(results.data);
                },
                error: function(err) {
                    console.error(err);
                    alert("Erro ao carregar! Se vocÃª estiver abrindo o arquivo direto do PC (file://), o navegador pode ter bloqueado. Tente usar um servidor local ou hospedar no GitHub.");
                }
            });
        }

        function processarDados(dados) {
            let totalOrcado = 0;
            let totalRealizado = 0;
            let categorias = {}; 
            let tabelaLinhas = [];

            dados.forEach(row => {
                // Mapeamento das colunas (baseado no seu CSV)
                // Ajuste os nomes entre aspas se mudarem na planilha
                let categoria = row['Categoria'];
                let subCategoria = row['Sub-Categoria'];
                let tipo = row['Tipo']; 
                let valorStr = row['Valor']; 
                // A coluna que define se Ã© OrÃ§amento ou Realizado:
                let origem = row['o que']; 
                let data = row['Data'];

                if (!categoria || !origem) return;

                let valor = limparValor(valorStr);

                // --- LÃ“GICA DE SOMA ---
                let origemNormalizada = origem.toLowerCase().trim();
                let tipoNormalizado = tipo ? tipo.toLowerCase().trim() : "";

                // OrÃ§amento
                if (origemNormalizada.includes('orÃ§amento')) {
                    // Se for Despesa no orÃ§amento, somamos ao total orÃ§ado
                    if (tipoNormalizado === 'despesa') {
                        if (!categorias[categoria]) categorias[categoria] = { orcado: 0, realizado: 0 };
                        categorias[categoria].orcado += valor;
                        totalOrcado += valor;
                    }
                } 
                // Realizado
                else if (origemNormalizada.includes('realizado')) {
                    // Se for Despesa realizada
                    if (tipoNormalizado === 'despesa') {
                        if (!categorias[categoria]) categorias[categoria] = { orcado: 0, realizado: 0 };
                        categorias[categoria].realizado += valor;
                        totalRealizado += valor;
                    }
                }

                // Preenche tabela
                tabelaLinhas.push([
                    data, categoria, subCategoria, tipo, origem, 
                    valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
                ]);
            });

            atualizarKPIs(totalOrcado, totalRealizado);
            atualizarGraficos(categorias);
            atualizarTabela(tabelaLinhas);
        }

        function atualizarKPIs(orcado, realizado) {
            document.getElementById('kpiOrcado').innerText = orcado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('kpiRealizado').innerText = realizado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            let saldo = orcado - realizado;
            let elSaldo = document.getElementById('kpiSaldo');
            elSaldo.innerText = saldo.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            let elStatus = document.getElementById('kpiStatus');
            if (saldo >= 0) {
                elSaldo.className = 'positivo';
                elStatus.innerText = "Dentro da Meta";
                elStatus.className = 'positivo';
            } else {
                elSaldo.className = 'negativo';
                elStatus.innerText = "Estourou o OrÃ§amento";
                elStatus.className = 'negativo';
            }
        }

        function atualizarGraficos(dadosCategorias) {
            const labels = Object.keys(dadosCategorias);
            const dadosOrcado = labels.map(cat => dadosCategorias[cat].orcado);
            const dadosRealizado = labels.map(cat => dadosCategorias[cat].realizado);

            // GrÃ¡fico 1: Comparativo
            const ctx1 = document.getElementById('chartComparativo').getContext('2d');
            if (chartComparativoInstancia) chartComparativoInstancia.destroy();
            
            chartComparativoInstancia = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'OrÃ§ado', data: dadosOrcado, backgroundColor: '#95a5a6' },
                        { label: 'Realizado', data: dadosRealizado, backgroundColor: '#c0392b' }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { title: { display: true, text: 'OrÃ§ado vs Realizado por Categoria' } }
                }
            });

            // GrÃ¡fico 2: Rosca
            const ctx2 = document.getElementById('chartCategorias').getContext('2d');
            if (chartCategoriasInstancia) chartCategoriasInstancia.destroy();

            chartCategoriasInstancia = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dadosRealizado,
                        backgroundColor: ['#e74c3c', '#8e44ad', '#3498db', '#f1c40f', '#2ecc71', '#34495e', '#e67e22', '#16a085']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { title: { display: true, text: 'Onde vocÃª gastou o dinheiro (Realizado)' } }
                }
            });
        }

        function atualizarTabela(dataset) {
            if ($.fn.DataTable.isDataTable('#tabelaDados')) {
                $('#tabelaDados').DataTable().destroy();
            }
            $('#tabelaDados').DataTable({
                data: dataset,
                language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json" },
                pageLength: 10,
                order: [[0, 'desc']] // Ordenar por data decrescente
            });
        }
    </script>
</body>
</html>
