<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro Familiar</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; margin: 0; padding: 20px; }
        
        .header { 
            background: #2c3e50; 
            color: white; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap;
            gap: 15px;
        }

        /* Caixa de Alerta para Diagn√≥stico */
        #status-msg {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: bold;
            display: none;
        }
        .status-erro { background-color: #ffeaa7; color: #d35400; border: 1px solid #fdcb6e; }
        .status-ok { background-color: #55efc4; color: #00b894; border: 1px solid #00b894; display: none !important;}

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 6px;
        }
        
        select { padding: 8px; border-radius: 4px; border: none; font-size: 16px; font-weight: bold; }
        .btn-update { background-color: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-update:hover { background-color: #219150; }

        .kpi-container { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .kpi-card { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; min-width: 200px; }
        .kpi-card h3 { margin: 0 0 10px 0; color: #7f8c8d; font-size: 14px; }
        .kpi-card p { font-size: 24px; font-weight: bold; margin: 0; color: #2c3e50; }
        
        .charts-container { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .chart-box { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); min-width: 400px; height: 400px; }
        .table-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;}
        
        .positivo { color: #27ae60 !important; }
        .negativo { color: #c0392b !important; }
        
        /* √Årea de Debug Raw */
        .debug-area { background: #dfe6e9; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 11px; color: #2d3436; }
    </style>
</head>
<body>

    <div id="status-msg" class="status-erro"></div>

    <div class="header">
        <div>
            <h1 style="margin:0;">üìä Painel Financeiro</h1>
            <small id="subtituloData">A carregar...</small>
        </div>
        
        <div class="filter-group">
            <label>üìÖ M√™s:</label>
            <select id="selMes" onchange="aplicarFiltro()">
                <option value="todos">Carregando...</option>
            </select>
            <button class="btn-update" onclick="carregarDados()">üîÑ Recarregar</button>
        </div>
    </div>

    <div class="kpi-container">
        <div class="kpi-card">
            <h3>Or√ßamento</h3>
            <p id="kpiOrcado">-</p>
        </div>
        <div class="kpi-card">
            <h3>Realizado</h3>
            <p id="kpiRealizado">-</p>
        </div>
        <div class="kpi-card">
            <h3>Saldo</h3>
            <p id="kpiSaldo">-</p>
        </div>
        <div class="kpi-card">
            <h3>Status</h3>
            <p id="kpiStatus">-</p>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-box">
            <canvas id="chartComparativo"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="chartCategorias"></canvas>
        </div>
    </div>

    <div class="table-container">
        <h3>Lan√ßamentos</h3>
        <table id="tabelaDados" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Categoria</th>
                    <th>Sub-Categoria</th>
                    <th>Tipo</th>
                    <th>Origem</th>
                    <th>Valor Final</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="debug-area">
        <strong>Diagn√≥stico de Dados (Primeiras 3 linhas recebidas):</strong>
        <pre id="debug-content">A aguardar dados...</pre>
    </div>

    <script>
        // SEU LINK FIXO:
        const LINK_PLANILHA = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_QrNqrn4TJZyIRm8HClxhYEU_vipX5qC_wF5sYmgbfnKPn5gl5HwNUB8SBnK_eI0U8_jiIrb7vTHE/pub?gid=1365210633&single=true&output=csv";

        let chartComparativoInstancia = null;
        let chartCategoriasInstancia = null;
        let DADOS_GLOBAIS = [];

        window.onload = carregarDados;

        function mostrarErro(msg) {
            let el = document.getElementById('status-msg');
            el.className = 'status-erro';
            el.style.display = 'block';
            el.innerHTML = "‚ö†Ô∏è " + msg;
        }

        function mostrarSucesso() {
            let el = document.getElementById('status-msg');
            el.style.display = 'none';
        }

        function limparValor(valorStr) {
            if (!valorStr) return 0;
            if (typeof valorStr === 'number') return valorStr;
            // Remove caracteres estranhos, mant√©m apenas n√∫meros, v√≠rgula, ponto e sinal de menos
            let limpo = valorStr.toString().replace("R$", "").replace(/\./g, "").replace(",", ".").trim();
            // Garante que h√≠fen normal seja usado para negativo
            limpo = limpo.replace("‚àí", "-"); 
            return parseFloat(limpo) || 0;
        }

        function extrairMesAno(dataStr) {
            if (!dataStr) return "";
            if (dataStr.includes('/')) {
                let partes = dataStr.split('/');
                if (partes.length >= 3) return partes[2].trim() + "-" + partes[1].trim(); 
            }
            let dataObj = new Date(dataStr);
            if (!isNaN(dataObj)) {
                let mes = (dataObj.getMonth() + 1).toString().padStart(2, '0');
                return dataObj.getFullYear() + "-" + mes;
            }
            return "";
        }

        function formatarMesAnoLegivel(chaveAnoMes) {
            if (!chaveAnoMes) return "-";
            let partes = chaveAnoMes.split('-');
            if(partes.length < 2) return chaveAnoMes;
            const nomes = ["", "Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            return `${nomes[parseInt(partes[1])]} de ${partes[0]}`;
        }

        function carregarDados() {
            mostrarErro("A conectar √† planilha...");
            
            Papa.parse(LINK_PLANILHA, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if(results.data.length === 0) {
                        mostrarErro("Conex√£o feita, mas a planilha veio vazia.");
                        return;
                    }
                    
                    // Mostra as primeiras linhas no rodap√© para diagn√≥stico
                    document.getElementById('debug-content').innerText = JSON.stringify(results.data.slice(0, 3), null, 2);
                    
                    DADOS_GLOBAIS = results.data;
                    popularFiltroMeses();
                    aplicarFiltro();
                    mostrarSucesso();
                },
                error: function(err) {
                    mostrarErro("Erro de Conex√£o: " + err.message + ". <br>Se estiveres no PC, o navegador pode ter bloqueado. Tenta no GitHub.");
                }
            });
        }

        function popularFiltroMeses() {
            let mesesUnicos = new Set();
            DADOS_GLOBAIS.forEach(row => {
                // Procura coluna Data ignorando mai√∫sculas
                let colData = Object.keys(row).find(k => k.toLowerCase().trim() === 'data');
                if(colData && row[colData]) {
                    let chave = extrairMesAno(row[colData]);
                    if (chave.length > 4) mesesUnicos.add(chave);
                }
            });
            
            let arrayMeses = Array.from(mesesUnicos).sort().reverse();
            let select = document.getElementById("selMes");
            select.innerHTML = '<option value="todos">Todos os Per√≠odos</option>';
            
            arrayMeses.forEach(mesChave => {
                let option = document.createElement("option");
                option.value = mesChave;
                option.text = formatarMesAnoLegivel(mesChave);
                select.appendChild(option);
            });

            // Seleciona m√™s atual se existir
            let hoje = new Date();
            let chaveAtual = hoje.getFullYear() + "-" + (hoje.getMonth()+1).toString().padStart(2,'0');
            if(arrayMeses.includes(chaveAtual)) select.value = chaveAtual;
            else if(arrayMeses.length > 0) select.value = arrayMeses[0];
        }

        function aplicarFiltro() {
            let filtro = document.getElementById("selMes").value;
            let dadosFiltrados = DADOS_GLOBAIS;

            if (filtro !== "todos") {
                dadosFiltrados = DADOS_GLOBAIS.filter(row => {
                    let colData = Object.keys(row).find(k => k.toLowerCase().trim() === 'data');
                    return colData && extrairMesAno(row[colData]) === filtro;
                });
                document.getElementById("subtituloData").innerText = formatarMesAnoLegivel(filtro);
            } else {
                document.getElementById("subtituloData").innerText = "Todo o Hist√≥rico";
            }

            processarEExibir(dadosFiltrados);
        }

        function processarEExibir(dados) {
            let totalOrcado = 0;
            let totalRealizado = 0;
            let categorias = {}; 
            let tabelaLinhas = [];

            dados.forEach(row => {
                // 1. Detectar nomes das colunas (Robustez)
                let keys = Object.keys(row);
                let kCategoria = keys.find(k => k.toLowerCase().trim() === 'categoria');
                let kSubCat = keys.find(k => k.toLowerCase().includes('sub'));
                let kTipo = keys.find(k => k.toLowerCase().trim() === 'tipo');
                let kOrigem = keys.find(k => k.toLowerCase().includes('o que')) || keys.find(k => k.toLowerCase().includes('origem'));
                let kData = keys.find(k => k.toLowerCase().trim() === 'data');
                
                // Estrat√©gia H√≠brida de Valor:
                let kValorAjustado = keys.find(k => k.toLowerCase().includes('ajustado'));
                let kValorBruto = keys.find(k => k.toLowerCase().trim() === 'valor');
                
                if (!kCategoria || !kOrigem || !row[kCategoria]) return;

                let tipo = row[kTipo] ? row[kTipo].toLowerCase().trim() : "";
                let origem = row[kOrigem].toLowerCase().trim();
                
                // L√ìGICA DE OURO: Tenta Valor Ajustado. Se falhar, calcula na hora.
                let valorFinal = 0;
                let valorRaw = (kValorAjustado) ? row[kValorAjustado] : "";
                
                if (valorRaw && valorRaw !== "") {
                    // Temos valor ajustado (j√° vem negativo)
                    valorFinal = limparValor(valorRaw);
                } else if (kValorBruto) {
                    // N√£o temos ajustado, calculamos manualmente
                    let bruto = limparValor(row[kValorBruto]);
                    if (tipo === 'despesa') valorFinal = bruto * -1;
                    else valorFinal = bruto;
                }

                if (valorFinal === 0 && row[kValorBruto] === "") return; // Pula linhas vazias

                // Agrega√ß√£o
                let categoria = row[kCategoria];
                if (!categorias[categoria]) categorias[categoria] = { orcado: 0, realizado: 0 };

                // Usamos Math.abs para gr√°ficos (mostrar volume positivo)
                let valorAbs = Math.abs(valorFinal);

                if (origem.includes('or√ßamento')) {
                    if (tipo === 'despesa') {
                        categorias[categoria].orcado += valorAbs;
                        totalOrcado += valorAbs;
                    }
                } else if (origem.includes('realizado')) {
                    if (tipo === 'despesa') {
                        categorias[categoria].realizado += valorAbs;
                        totalRealizado += valorAbs;
                    }
                }

                tabelaLinhas.push([
                    row[kData], categoria, row[kSubCat]||'-', row[kTipo], row[kOrigem], 
                    valorFinal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
                ]);
            });

            atualizarKPIs(totalOrcado, totalRealizado);
            atualizarGraficos(categorias);
            atualizarTabela(tabelaLinhas);
        }

        function atualizarKPIs(orcado, realizado) {
            document.getElementById('kpiOrcado').innerText = orcado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('kpiRealizado').innerText = realizado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            let saldo = orcado - realizado;
            let elSaldo = document.getElementById('kpiSaldo');
            elSaldo.innerText = saldo.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            let elStatus = document.getElementById('kpiStatus');
            if (saldo >= 0) {
                elSaldo.className = 'positivo';
                elStatus.innerText = "Dentro da Meta";
                elStatus.className = 'positivo';
            } else {
                elSaldo.className = 'negativo';
                elStatus.innerText = "Estourou";
                elStatus.className = 'negativo';
            }
        }

        function atualizarGraficos(dadosCategorias) {
            const labels = Object.keys(dadosCategorias);
            const dadosOrcado = labels.map(cat => dadosCategorias[cat].orcado);
            const dadosRealizado = labels.map(cat => dadosCategorias[cat].realizado);

            const ctx1 = document.getElementById('chartComparativo').getContext('2d');
            if (chartComparativoInstancia) chartComparativoInstancia.destroy();
            
            chartComparativoInstancia = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Or√ßado', data: dadosOrcado, backgroundColor: '#95a5a6', borderRadius: 4 },
                        { label: 'Realizado', data: dadosRealizado, backgroundColor: '#c0392b', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { title: { display: true, text: 'Comparativo Or√ßado vs Realizado' } }
                }
            });

            const ctx2 = document.getElementById('chartCategorias').getContext('2d');
            if (chartCategoriasInstancia) chartCategoriasInstancia.destroy();

            let labelsRosca = [];
            let dadosRosca = [];
            labels.forEach((label, index) => {
                if (dadosRealizado[index] > 0) {
                    labelsRosca.push(label);
                    dadosRosca.push(dadosRealizado[index]);
                }
            });

            chartCategoriasInstancia = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: labelsRosca,
                    datasets: [{
                        data: dadosRosca,
                        backgroundColor: ['#e74c3c', '#8e44ad', '#3498db', '#f1c40f', '#2ecc71', '#34495e', '#e67e22', '#16a085']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        title: { display: true, text: 'Para onde foi o dinheiro' },
                        legend: { position: 'right' }
                    }
                }
            });
        }

        function atualizarTabela(dataset) {
            if ($.fn.DataTable.isDataTable('#tabelaDados')) {
                $('#tabelaDados').DataTable().destroy();
            }
            $('#tabelaDados').DataTable({
                data: dataset,
                language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json" },
                pageLength: 10,
                order: [[0, 'desc']] 
            });
        }
    </script>
</body>
</html>