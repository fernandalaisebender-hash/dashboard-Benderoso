<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro Familiar</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; margin: 0; padding: 20px; }
        
        .header { 
            background: #2c3e50; 
            color: white; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap;
            gap: 15px;
        }

        /* √Årea de Log de Erros (Diagn√≥stico) */
        #debug-log {
            background: #ffeaa7;
            color: #d35400;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 10px;
            border: 1px solid #fdcb6e;
            display: none; /* S√≥ aparece se tiver mensagem */
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 6px;
        }
        
        select {
            padding: 8px;
            border-radius: 4px;
            border: none;
            font-size: 16px;
            cursor: pointer;
            background-color: #fff;
            color: #333;
            font-weight: bold;
        }

        .btn-update { background-color: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-update:hover { background-color: #219150; }

        .kpi-container { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .kpi-card { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; min-width: 200px; }
        .kpi-card h3 { margin: 0 0 10px 0; color: #7f8c8d; font-size: 14px; }
        .kpi-card p { font-size: 24px; font-weight: bold; margin: 0; color: #2c3e50; }
        
        .charts-container { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .chart-box { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); min-width: 400px; height: 400px; }
        .table-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .positivo { color: #27ae60 !important; }
        .negativo { color: #c0392b !important; }
    </style>
</head>
<body>

    <div id="debug-log"></div>

    <div class="header">
        <div>
            <h1 style="margin:0;">üìä Painel Financeiro</h1>
            <small id="subtituloData">Aguardando dados...</small>
        </div>
        
        <div class="filter-group">
            <label>üìÖ M√™s:</label>
            <select id="selMes" onchange="aplicarFiltro()">
                <option value="todos">Carregando...</option>
            </select>
            <button class="btn-update" onclick="carregarDados()">üîÑ Recarregar</button>
        </div>
    </div>

    <div class="kpi-container">
        <div class="kpi-card">
            <h3>Or√ßamento</h3>
            <p id="kpiOrcado">-</p>
        </div>
        <div class="kpi-card">
            <h3>Realizado</h3>
            <p id="kpiRealizado">-</p>
        </div>
        <div class="kpi-card">
            <h3>Saldo</h3>
            <p id="kpiSaldo">-</p>
        </div>
        <div class="kpi-card">
            <h3>Status</h3>
            <p id="kpiStatus">-</p>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-box">
            <canvas id="chartComparativo"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="chartCategorias"></canvas>
        </div>
    </div>

    <div class="table-container">
        <h3>Lan√ßamentos (Valor Ajustado)</h3>
        <table id="tabelaDados" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Categoria</th>
                    <th>Sub-Categoria</th>
                    <th>Tipo</th>
                    <th>Origem</th>
                    <th>Valor</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // SEU LINK FIXO:
        const LINK_PLANILHA = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_QrNqrn4TJZyIRm8HClxhYEU_vipX5qC_wF5sYmgbfnKPn5gl5HwNUB8SBnK_eI0U8_jiIrb7vTHE/pub?gid=1365210633&single=true&output=csv";

        let chartComparativoInstancia = null;
        let chartCategoriasInstancia = null;
        let DADOS_GLOBAIS = [];

        window.onload = carregarDados;

        function logDebug(msg) {
            console.log(msg);
            let el = document.getElementById('debug-log');
            el.style.display = 'block';
            el.innerHTML += ">> " + msg + "<br>";
        }

        // Fun√ß√£o robusta para limpar valores
        function limparValor(valorStr) {
            if (!valorStr) return 0;
            if (typeof valorStr === 'number') return valorStr;
            // Remove R$, espa√ßos e converte , para .
            let limpo = valorStr.replace("R$", "").replace(/\./g, "").replace(",", ".").trim();
            // Remove caracteres invis√≠veis que o Excel √†s vezes coloca
            limpo = limpo.replace(/[^0-9.-]/g, '');
            return parseFloat(limpo) || 0;
        }

        // Fun√ß√£o robusta para extrair m√™s
        function extrairMesAno(dataStr) {
            if (!dataStr) return "";
            
            // Tenta formato DD/MM/YYYY
            if (dataStr.includes('/')) {
                let partes = dataStr.split('/');
                if (partes.length >= 3) {
                    // partes[2] = Ano, partes[1] = M√™s
                    return partes[2].trim() + "-" + partes[1].trim(); 
                }
            }
            // Tenta formato YYYY-MM-DD (padr√£o Google Sheets √†s vezes)
            let dataObj = new Date(dataStr);
            if (!isNaN(dataObj)) {
                let mes = (dataObj.getMonth() + 1).toString().padStart(2, '0');
                return dataObj.getFullYear() + "-" + mes;
            }
            return "";
        }

        function formatarMesAnoLegivel(chaveAnoMes) {
            if (!chaveAnoMes) return "-";
            let partes = chaveAnoMes.split('-');
            if(partes.length < 2) return chaveAnoMes;
            
            let ano = partes[0];
            let mes = parseInt(partes[1]);
            const nomes = ["", "Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            return `${nomes[mes]} de ${ano}`;
        }

        function carregarDados() {
            logDebug("Iniciando download da planilha...");
            
            Papa.parse(LINK_PLANILHA, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    logDebug("Download conclu√≠do. Linhas recebidas: " + results.data.length);
                    
                    if(results.data.length === 0) {
                        logDebug("ERRO CR√çTICO: Planilha veio vazia. Verifique o link.");
                        return;
                    }

                    // Verifica se as colunas existem (imprime a primeira linha para checar headers)
                    let colunasRecebidas = Object.keys(results.data[0]);
                    logDebug("Colunas encontradas: " + colunasRecebidas.join(", "));

                    // Verifica colunas essenciais
                    let temData = colunasRecebidas.some(c => c.toLowerCase().trim() === 'data');
                    let temValorAjustado = colunasRecebidas.some(c => c.toLowerCase().includes('ajustado'));

                    if (!temData) logDebug("ALERTA: Coluna 'Data' n√£o encontrada. Verifique o CSV.");
                    if (!temValorAjustado) logDebug("ALERTA: Coluna 'Valor ajustado' n√£o encontrada. Tentaremos 'Valor'.");

                    DADOS_GLOBAIS = results.data;
                    try {
                        popularFiltroMeses();
                        aplicarFiltro();
                        logDebug("Dashboard atualizado com sucesso!");
                        // Esconde o log se tudo correu bem ap√≥s 3 segundos
                        setTimeout(() => { document.getElementById('debug-log').style.display = 'none'; }, 5000);
                    } catch (e) {
                        logDebug("ERRO JS: " + e.message);
                    }
                },
                error: function(err) {
                    logDebug("ERRO DE CONEX√ÉO: " + err.name + " - " + err.message);
                    logDebug("DICA: Se est√°s a abrir o arquivo direto do PC (file://), o navegador bloqueou. Usa o GitHub Pages ou um servidor local.");
                }
            });
        }

        function popularFiltroMeses() {
            let mesesUnicos = new Set();
            DADOS_GLOBAIS.forEach(row => {
                // Tenta achar a coluna de Data independente de mai√∫sculas/min√∫sculas
                let colData = Object.keys(row).find(k => k.toLowerCase().trim() === 'data');
                if(colData) {
                    let chave = extrairMesAno(row[colData]);
                    if (chave && chave.length > 4) mesesUnicos.add(chave);
                }
            });
            
            let arrayMeses = Array.from(mesesUnicos).sort().reverse();
            let select = document.getElementById("selMes");
            select.innerHTML = '<option value="todos">Todos os Per√≠odos</option>';
            
            arrayMeses.forEach(mesChave => {
                let option = document.createElement("option");
                option.value = mesChave;
                option.text = formatarMesAnoLegivel(mesChave);
                select.appendChild(option);
            });

            // L√≥gica do M√™s Atual
            let dataHoje = new Date();
            let mesAtual = (dataHoje.getMonth() + 1).toString().padStart(2, '0');
            let anoAtual = dataHoje.getFullYear();
            let chaveAtual = `${anoAtual}-${mesAtual}`;

            if (arrayMeses.includes(chaveAtual)) {
                select.value = chaveAtual;
            } else if (arrayMeses.length > 0) {
                select.value = arrayMeses[0];
            }
        }

        function aplicarFiltro() {
            let filtro = document.getElementById("selMes").value;
            let dadosFiltrados;

            if (filtro === "todos") {
                dadosFiltrados = DADOS_GLOBAIS;
                document.getElementById("subtituloData").innerText = "Todo o Hist√≥rico";
            } else {
                dadosFiltrados = DADOS_GLOBAIS.filter(row => {
                    let colData = Object.keys(row).find(k => k.toLowerCase().trim() === 'data');
                    return colData && extrairMesAno(row[colData]) === filtro;
                });
                document.getElementById("subtituloData").innerText = formatarMesAnoLegivel(filtro);
            }

            processarEExibir(dadosFiltrados);
        }

        function processarEExibir(dados) {
            let totalOrcado = 0;
            let totalRealizado = 0;
            let categorias = {}; 
            let tabelaLinhas = [];

            dados.forEach(row => {
                // Busca de colunas inteligente (Case Insensitive)
                let keys = Object.keys(row);
                let kCategoria = keys.find(k => k.toLowerCase().trim() === 'categoria');
                let kSubCat = keys.find(k => k.toLowerCase().trim() === 'sub-categoria') || keys.find(k => k.toLowerCase().trim() === 'subcategoria');
                let kTipo = keys.find(k => k.toLowerCase().trim() === 'tipo');
                let kOrigem = keys.find(k => k.toLowerCase().trim() === 'o que') || keys.find(k => k.toLowerCase().trim() === 'origem');
                let kData = keys.find(k => k.toLowerCase().trim() === 'data');
                
                // Prioriza Valor Ajustado, se n√£o tiver, pega Valor
                let kValorAjustado = keys.find(k => k.toLowerCase().includes('ajustado'));
                let kValor = keys.find(k => k.toLowerCase().trim() === 'valor');
                
                if (!kCategoria || !kOrigem || !row[kCategoria]) return;

                let categoria = row[kCategoria];
                let subCategoria = kSubCat ? row[kSubCat] : '-';
                let tipo = row[kTipo] || '';
                let origem = row[kOrigem];
                let data = row[kData];

                let valorRaw = (kValorAjustado && row[kValorAjustado]) ? row[kValorAjustado] : row[kValor];
                let valor = limparValor(valorRaw); 
                
                let origemNorm = origem.toLowerCase().trim();
                let tipoNorm = tipo.toLowerCase().trim();

                if (!categorias[categoria]) categorias[categoria] = { orcado: 0, realizado: 0 };

                // L√≥gica de Soma (usando Math.abs para gr√°ficos positivos)
                if (origemNorm.includes('or√ßamento')) {
                    if (tipoNorm === 'despesa') {
                        let val = Math.abs(valor);
                        categorias[categoria].orcado += val;
                        totalOrcado += val;
                    }
                } else if (origemNorm.includes('realizado')) {
                    if (tipoNorm === 'despesa') {
                        let val = Math.abs(valor);
                        categorias[categoria].realizado += val;
                        totalRealizado += val;
                    }
                }

                tabelaLinhas.push([
                    data, categoria, subCategoria, tipo, origem, 
                    valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
                ]);
            });

            atualizarKPIs(totalOrcado, totalRealizado);
            atualizarGraficos(categorias);
            atualizarTabela(tabelaLinhas);
        }

        function atualizarKPIs(orcado, realizado) {
            document.getElementById('kpiOrcado').innerText = orcado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('kpiRealizado').innerText = realizado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            let saldo = orcado - realizado;
            let elSaldo = document.getElementById('kpiSaldo');
            elSaldo.innerText = saldo.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            let elStatus = document.getElementById('kpiStatus');
            if (saldo >= 0) {
                elSaldo.className = 'positivo';
                elStatus.innerText = "Dentro da Meta";
                elStatus.className = 'positivo';
            } else {
                elSaldo.className = 'negativo';
                elStatus.innerText = "Estourou o Or√ßamento";
                elStatus.className = 'negativo';
            }
        }

        function atualizarGraficos(dadosCategorias) {
            const labels = Object.keys(dadosCategorias);
            const dadosOrcado = labels.map(cat => dadosCategorias[cat].orcado);
            const dadosRealizado = labels.map(cat => dadosCategorias[cat].realizado);

            const ctx1 = document.getElementById('chartComparativo').getContext('2d');
            if (chartComparativoInstancia) chartComparativoInstancia.destroy();
            
            chartComparativoInstancia = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Or√ßado', data: dadosOrcado, backgroundColor: '#95a5a6', borderRadius: 4 },
                        { label: 'Realizado', data: dadosRealizado, backgroundColor: '#c0392b', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { title: { display: true, text: 'Or√ßado vs Realizado' } }
                }
            });

            const ctx2 = document.getElementById('chartCategorias').getContext('2d');
            if (chartCategoriasInstancia) chartCategoriasInstancia.destroy();

            let labelsRosca = [];
            let dadosRosca = [];
            labels.forEach((label, index) => {
                if (dadosRealizado[index] > 0) {
                    labelsRosca.push(label);
                    dadosRosca.push(dadosRealizado[index]);
                }
            });

            chartCategoriasInstancia = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: labelsRosca,
                    datasets: [{
                        data: dadosRosca,
                        backgroundColor: ['#e74c3c', '#8e44ad', '#3498db', '#f1c40f', '#2ecc71', '#34495e', '#e67e22', '#16a085']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        title: { display: true, text: 'Distribui√ß√£o dos Gastos' },
                        legend: { position: 'right' }
                    }
                }
            });
        }

        function atualizarTabela(dataset) {
            if ($.fn.DataTable.isDataTable('#tabelaDados')) {
                $('#tabelaDados').DataTable().destroy();
            }
            $('#tabelaDados').DataTable({
                data: dataset,
                language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json" },
                pageLength: 10,
                order: [[0, 'desc']] 
            });
        }
    </script>
</body>
</html>