<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro 3.0</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        
        .header { 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); 
            color: white; 
            padding: 25px; 
            border-radius: 12px; 
            margin-bottom: 25px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 8px;
        }
        
        select { padding: 8px; border-radius: 6px; border: none; font-size: 15px; font-weight: bold; color: #1e3c72; outline: none;}
        .btn-update { background-color: #00b894; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-update:hover { background-color: #00cec9; transform: translateY(-2px); }

        /* KPIs */
        .kpi-container { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
        .kpi-card { 
            flex: 1; 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            text-align: center; 
            min-width: 200px; 
            border-left: 5px solid #bdc3c7;
        }
        .kpi-card h3 { margin: 0 0 5px 0; color: #7f8c8d; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; }
        .kpi-card p { font-size: 26px; font-weight: 800; margin: 0; color: #2c3e50; }
        .kpi-card small { font-size: 12px; color: #95a5a6; }

        .kpi-blue { border-left-color: #3498db; }
        .kpi-green { border-left-color: #27ae60; }
        .kpi-red { border-left-color: #c0392b; }
        .kpi-gold { border-left-color: #f1c40f; }

        /* Gr√°ficos e Tabelas */
        .section-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; border-left: 4px solid #2c3e50; padding-left: 10px; color: #2c3e50; }
        .grid-charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: 350px; }
        
        .table-container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        .positivo { color: #27ae60 !important; }
        .negativo { color: #c0392b !important; }

        /* Loading Overlay */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom:15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner"></div>
        <h2>Carregando seus dados...</h2>
    </div>

    <div class="header">
        <div>
            <h1 style="margin:0;">üìä Painel Financeiro</h1>
            <small id="subtituloData">Vis√£o Geral</small>
        </div>
        
        <div class="filter-group">
            <label>üìÖ Per√≠odo:</label>
            <select id="selMes" onchange="aplicarFiltro()">
                <option value="todos">Todos os Dados</option>
            </select>
            <button class="btn-update" onclick="location.reload()">üîÑ Atualizar</button>
        </div>
    </div>

    <div class="section-title">üí∞ An√°lise de Caixa (Realizado)</div>
    <div class="kpi-container">
        <div class="kpi-card kpi-blue">
            <h3>Receitas (Entradas)</h3>
            <p id="kpiReceitaReal">R$ 0,00</p>
            <small>Dinheiro que entrou na conta</small>
        </div>
        <div class="kpi-card kpi-red">
            <h3>Despesas (Sa√≠das)</h3>
            <p id="kpiDespesaReal">R$ 0,00</p>
            <small>Dinheiro que saiu da conta</small>
        </div>
        <div class="kpi-card kpi-green">
            <h3>Saldo em Caixa</h3>
            <p id="kpiSaldoCaixa">R$ 0,00</p>
            <small>Receitas - Despesas</small>
        </div>
    </div>

    <div class="grid-charts">
        <div class="chart-box">
            <canvas id="chartFluxoCaixa"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="chartReceitaVsDespesa"></canvas>
        </div>
    </div>

    <div class="section-title">üìâ Varia√ß√£o do Or√ßamento (Planejado vs Real)</div>
    <div class="kpi-container">
        <div class="kpi-card kpi-gold">
            <h3>Despesa Or√ßada</h3>
            <p id="kpiDespesaOrc">R$ 0,00</p>
            <small>Limite definido</small>
        </div>
        <div class="kpi-card kpi-red">
            <h3>Despesa Realizada</h3>
            <p id="kpiDespesaReal2">R$ 0,00</p>
            <small>Gasto efetivo</small>
        </div>
        <div class="kpi-card">
            <h3>Varia√ß√£o</h3>
            <p id="kpiVariacao">R$ 0,00</p>
            <small id="kpiVariacaoText">Diferen√ßa</small>
        </div>
    </div>

    <div class="grid-charts">
        <div class="chart-box" style="grid-column: span 2;">
            <canvas id="chartOrcadoVsRealizado"></canvas>
        </div>
    </div>

    <div class="table-container">
        <div class="section-title">üìù Detalhes dos Lan√ßamentos</div>
        <table id="tabelaDados" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Tipo</th>
                    <th>Categoria</th>
                    <th>Sub-Categoria</th>
                    <th>Valor</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // LINK DA SUA PLANILHA
        const LINK_PLANILHA = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_QrNqrn4TJZyIRm8HClxhYEU_vipX5qC_wF5sYmgbfnKPn5gl5HwNUB8SBnK_eI0U8_jiIrb7vTHE/pub?gid=1365210633&single=true&output=csv";

        let DADOS_GLOBAIS = [];
        let chartFluxoCaixa = null;
        let chartReceitaVsDespesa = null;
        let chartOrcadoVsRealizado = null;

        window.onload = carregarDados;

        // --- FUN√á√ïES AUXILIARES ---
        function limparValor(valorStr) {
            if (!valorStr) return 0;
            if (typeof valorStr === 'number') return valorStr;
            let limpo = valorStr.toString().replace("R$", "").replace(/\./g, "").replace(",", ".").trim();
            limpo = limpo.replace(/[^0-9.-]/g, ''); // Remove caracteres invis√≠veis
            return parseFloat(limpo) || 0;
        }

        function extrairMesAno(dataStr) {
            if (!dataStr) return "";
            if (dataStr.includes('/')) {
                let partes = dataStr.split('/');
                if (partes.length >= 3) return partes[2].trim() + "-" + partes[1].trim(); 
            }
            let dataObj = new Date(dataStr);
            if (!isNaN(dataObj)) {
                let mes = (dataObj.getMonth() + 1).toString().padStart(2, '0');
                return dataObj.getFullYear() + "-" + mes;
            }
            return "";
        }

        function formatarMoeda(val) {
            return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function formatarDataLegivel(chave) {
            if(!chave) return "";
            let [ano, mes] = chave.split('-');
            const nomes = ["", "Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            return `${nomes[parseInt(mes)]} de ${ano}`;
        }

        // --- CARREGAMENTO ---
        function carregarDados() {
            Papa.parse(LINK_PLANILHA, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    DADOS_GLOBAIS = results.data;
                    document.getElementById('loading').style.display = 'none';
                    if(DADOS_GLOBAIS.length === 0) { alert("Planilha vazia!"); return; }
                    
                    popularFiltroMeses();
                    aplicarFiltro();
                },
                error: function(err) {
                    alert("Erro ao carregar: " + err.message);
                }
            });
        }

        function popularFiltroMeses() {
            let meses = new Set();
            DADOS_GLOBAIS.forEach(row => {
                let kData = Object.keys(row).find(k => k.toLowerCase().trim() === 'data');
                if(kData && row[kData]) {
                    let chave = extrairMesAno(row[kData]);
                    if(chave.length > 4) meses.add(chave);
                }
            });
            let sorted = Array.from(meses).sort().reverse();
            let sel = document.getElementById("selMes");
            sorted.forEach(m => {
                let opt = document.createElement("option");
                opt.value = m;
                opt.text = formatarDataLegivel(m);
                sel.appendChild(opt);
            });

            // Seleciona m√™s atual
            let hoje = new Date();
            let atual = hoje.getFullYear() + "-" + (hoje.getMonth()+1).toString().padStart(2,'0');
            if(sorted.includes(atual)) sel.value = atual;
            else if(sorted.length > 0) sel.value = sorted[0];
        }

        function aplicarFiltro() {
            let filtro = document.getElementById("selMes").value;
            let dadosFiltrados = DADOS_GLOBAIS;
            
            if(filtro !== "todos") {
                dadosFiltrados = DADOS_GLOBAIS.filter(row => {
                    let kData = Object.keys(row).find(k => k.toLowerCase().trim() === 'data');
                    return kData && extrairMesAno(row[kData]) === filtro;
                });
                document.getElementById("subtituloData").innerText = formatarDataLegivel(filtro);
            } else {
                document.getElementById("subtituloData").innerText = "Hist√≥rico Completo";
            }
            
            processarDados(dadosFiltrados);
        }

        function processarDados(dados) {
            let totalReceitaReal = 0;
            let totalDespesaReal = 0;
            let totalDespesaOrc = 0;
            let categorias = {};
            let tabela = [];

            dados.forEach(row => {
                // Mapeamento de colunas
                let keys = Object.keys(row);
                let kData = keys.find(k => k.toLowerCase().trim() === 'data');
                let kTipo = keys.find(k => k.toLowerCase().trim() === 'tipo');
                let kCat = keys.find(k => k.toLowerCase().trim() === 'categoria');
                let kSub = keys.find(k => k.toLowerCase().includes('sub'));
                let kOrigem = keys.find(k => k.toLowerCase().includes('o que') || k.toLowerCase().includes('origem'));
                
                // Prioriza Valor Ajustado, sen√£o Valor
                let kValAdj = keys.find(k => k.toLowerCase().includes('ajustado'));
                let kVal = keys.find(k => k.toLowerCase().trim() === 'valor');

                if(!kData || !kTipo || !kCat) return;

                let tipo = (row[kTipo] || "").toLowerCase().trim();
                let origem = (row[kOrigem] || "").toLowerCase().trim();
                let cat = row[kCat];

                // Pega valor bruto
                let valorBruto = 0;
                if(kValAdj && row[kValAdj]) valorBruto = limparValor(row[kValAdj]);
                else if(kVal && row[kVal]) valorBruto = limparValor(row[kVal]);

                // Transforma tudo em positivo (magnitude) para facilitar somas e gr√°ficos
                let valorAbs = Math.abs(valorBruto);
                if(valorAbs === 0) return;

                // L√≥gica de Somas e Categorias
                if(!categorias[cat]) categorias[cat] = { orcado: 0, realizado: 0 };

                if(origem.includes('realizado')) {
                    if(tipo === 'receita') totalReceitaReal += valorAbs;
                    if(tipo === 'despesa') {
                        totalDespesaReal += valorAbs;
                        categorias[cat].realizado += valorAbs;
                    }
                } else if(origem.includes('or√ßamento')) {
                    if(tipo === 'despesa') {
                        totalDespesaOrc += valorAbs;
                        categorias[cat].orcado += valorAbs;
                    }
                }

                tabela.push([
                    row[kData], 
                    tipo.charAt(0).toUpperCase() + tipo.slice(1), 
                    cat, 
                    row[kSub] || '-', 
                    formatarMoeda(valorAbs), 
                    origem.includes('orc') ? 'Or√ßado' : 'Realizado'
                ]);
            });

            atualizarKPIs(totalReceitaReal, totalDespesaReal, totalDespesaOrc);
            atualizarGraficos(totalReceitaReal, totalDespesaReal, categorias);
            atualizarTabela(tabela);
        }

        function atualizarKPIs(recReal, despReal, despOrc) {
            // Caixa
            document.getElementById('kpiReceitaReal').innerText = formatarMoeda(recReal);
            document.getElementById('kpiDespesaReal').innerText = formatarMoeda(despReal);
            
            let saldoCaixa = recReal - despReal;
            let elSaldo = document.getElementById('kpiSaldoCaixa');
            elSaldo.innerText = formatarMoeda(saldoCaixa);
            elSaldo.className = saldoCaixa >= 0 ? 'positivo' : 'negativo';

            // Or√ßamento
            document.getElementById('kpiDespesaOrc').innerText = formatarMoeda(despOrc);
            document.getElementById('kpiDespesaReal2').innerText = formatarMoeda(despReal);
            
            let variacao = despOrc - despReal;
            let elVar = document.getElementById('kpiVariacao');
            elVar.innerText = formatarMoeda(variacao);
            
            let elVarTxt = document.getElementById('kpiVariacaoText');
            if(variacao >= 0) {
                elVar.className = 'positivo';
                elVarTxt.innerText = "Economia (Sobrou)";
            } else {
                elVar.className = 'negativo';
                elVarTxt.innerText = "Estouro (Faltou)";
            }
        }

        function atualizarGraficos(recReal, despReal, cats) {
            // Gr√°fico 1: Receita vs Despesa (Caixa)
            if(chartReceitaVsDespesa) chartReceitaVsDespesa.destroy();
            chartReceitaVsDespesa = new Chart(document.getElementById('chartReceitaVsDespesa'), {
                type: 'doughnut',
                data: {
                    labels: ['Receita (Entrou)', 'Despesa (Saiu)'],
                    datasets: [{
                        data: [recReal, despReal],
                        backgroundColor: ['#27ae60', '#c0392b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    plugins: { title: { display: true, text: 'Balan√ßo de Caixa' } }
                }
            });

            // Gr√°fico 2: Fluxo (Barras)
            if(chartFluxoCaixa) chartFluxoCaixa.destroy();
            chartFluxoCaixa = new Chart(document.getElementById('chartFluxoCaixa'), {
                type: 'bar',
                data: {
                    labels: ['Fluxo de Caixa'],
                    datasets: [
                        { label: 'Receitas', data: [recReal], backgroundColor: '#27ae60', borderRadius: 5 },
                        { label: 'Despesas', data: [despReal], backgroundColor: '#c0392b', borderRadius: 5 }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    plugins: { title: { display: true, text: 'Comparativo Direto' } }
                }
            });

            // Gr√°fico 3: Or√ßamento por Categoria
            let labels = Object.keys(cats);
            let dadosOrc = labels.map(c => cats[c].orcado);
            let dadosReal = labels.map(c => cats[c].realizado);

            if(chartOrcadoVsRealizado) chartOrcadoVsRealizado.destroy();
            chartOrcadoVsRealizado = new Chart(document.getElementById('chartOrcadoVsRealizado'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Or√ßado', data: dadosOrc, backgroundColor: '#f1c40f' },
                        { label: 'Realizado (Gasto)', data: dadosReal, backgroundColor: '#c0392b' }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { title: { display: true, text: 'Onde o dinheiro foi gasto vs Planejado' } }
                }
            });
        }

        function atualizarTabela(rows) {
            if ($.fn.DataTable.isDataTable('#tabelaDados')) {
                $('#tabelaDados').DataTable().destroy();
            }
            $('#tabelaDados').DataTable({
                data: rows,
                language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json" },
                pageLength: 5,
                order: [[0, 'desc']]
            });
        }
    </script>
</body>
</html>