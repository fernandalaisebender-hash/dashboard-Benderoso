<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro 4.0 (BI Interativo)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        
        .header { 
            background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%); 
            color: white; 
            padding: 20px 30px; 
            border-radius: 12px; 
            margin-bottom: 25px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .controls-area { display: flex; gap: 15px; align-items: center; }

        .filter-group {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        select { padding: 8px; border-radius: 6px; border: none; font-size: 15px; font-weight: bold; color: #2c3e50; outline: none;}
        
        .btn-reset { 
            background-color: #e74c3c; 
            color: white; 
            border: none; 
            padding: 8px 15px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold; 
            display: none; /* Escondido por padr√£o */
            animation: fadeIn 0.3s;
        }

        .btn-update { background-color: #00b894; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        /* KPIs */
        .kpi-container { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
        .kpi-card { 
            flex: 1; 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            text-align: center; 
            min-width: 180px; 
            border-top: 4px solid #bdc3c7;
        }
        .kpi-card h3 { margin: 0 0 5px 0; color: #7f8c8d; font-size: 12px; text-transform: uppercase; }
        .kpi-card p { font-size: 24px; font-weight: 800; margin: 0; color: #2c3e50; }
        
        .kpi-blue { border-top-color: #3498db; }
        .kpi-green { border-top-color: #27ae60; }
        .kpi-red { border-top-color: #c0392b; }
        .kpi-gold { border-top-color: #f1c40f; }

        /* Gr√°ficos */
        .section-title { font-size: 18px; font-weight: bold; margin: 30px 0 15px 0; border-left: 5px solid #2c3e50; padding-left: 10px; color: #2c3e50; }
        .grid-charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: 400px; position: relative; }
        .chart-hint { position: absolute; top: 10px; right: 15px; font-size: 11px; color: #95a5a6; font-style: italic; }

        /* Tabela */
        .table-container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .badge-o { background: #f1c40f; color: #333; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
        .badge-r { background: #27ae60; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }

        /* Loading */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom:15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner"></div>
        <h3 style="color:#2c3e50">Carregando Dashboard...</h3>
    </div>

    <div class="header">
        <div>
            <h1 style="margin:0; font-size: 24px;">üìä Dashboard Interativo</h1>
            <small id="subtituloData" style="opacity: 0.9;">Vis√£o Geral</small>
        </div>
        
        <div class="controls-area">
            <button id="btnLimpar" class="btn-reset" onclick="limparFiltrosInterativos()">‚ùå Limpar Filtros</button>
            
            <div class="filter-group">
                <label>üìÖ M√™s:</label>
                <select id="selMes" onchange="mudarMes()"></select>
            </div>
            
            <button class="btn-update" onclick="location.reload()">üîÑ</button>
        </div>
    </div>

    <div class="kpi-container">
        <div class="kpi-card kpi-blue">
            <h3>Entradas (R)</h3>
            <p id="kpiReceita">R$ 0,00</p>
        </div>
        <div class="kpi-card kpi-red">
            <h3>Sa√≠das (R)</h3>
            <p id="kpiDespesa">R$ 0,00</p>
        </div>
        <div class="kpi-card kpi-green">
            <h3>Saldo Caixa</h3>
            <p id="kpiSaldo">R$ 0,00</p>
        </div>
        <div class="kpi-card kpi-gold">
            <h3>Or√ßado (O)</h3>
            <p id="kpiOrcado">R$ 0,00</p>
        </div>
        <div class="kpi-card">
            <h3>Varia√ß√£o</h3>
            <p id="kpiVariacao">R$ 0,00</p>
        </div>
    </div>

    <div class="grid-charts">
        <div class="chart-box">
            <span class="chart-hint">üëÜ Clique na barra para filtrar</span>
            <canvas id="chartCategorias"></canvas>
        </div>
        <div class="chart-box">
            <span class="chart-hint">üëÜ Clique na fatia para filtrar</span>
            <canvas id="chartPagamentos"></canvas>
        </div>
    </div>

    <div class="grid-charts" style="grid-template-columns: 1fr 1fr;">
        <div class="chart-box" style="height: 300px;">
            <canvas id="chartFluxo"></canvas>
        </div>
        <div class="chart-box" style="height: 300px;">
             <canvas id="chartReceitaDespesa"></canvas>
        </div>
    </div>

    <div class="table-container">
        <div class="section-title" style="margin-top:0">üìù Detalhes dos Lan√ßamentos</div>
        <table id="tabelaDados" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>St</th>
                    <th>Tipo</th>
                    <th>Categoria</th>
                    <th>Sub-Categoria</th>
                    <th>Descri√ß√£o</th> <th>Pgto</th>
                    <th>Valor</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO ---
        const LINK_PLANILHA = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_QrNqrn4TJZyIRm8HClxhYEU_vipX5qC_wF5sYmgbfnKPn5gl5HwNUB8SBnK_eI0U8_jiIrb7vTHE/pub?gid=1365210633&single=true&output=csv";

        // Vari√°veis Globais de Estado
        let DADOS_BRUTOS = [];
        let DADOS_MES_ATUAL = []; // Dados filtrados pelo m√™s
        let FILTRO_INTERATIVO = { categoria: null, pagamento: null }; // Filtros de clique
        
        // Inst√¢ncias dos Gr√°ficos
        let chartCats = null, chartPgtos = null, chartFluxo = null, chartRecDesp = null;

        window.onload = carregarDados;

        // --- MANIPULA√á√ÉO DE DADOS ---
        function carregarDados() {
            Papa.parse(LINK_PLANILHA, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(res) {
                    DADOS_BRUTOS = res.data;
                    document.getElementById('loading').style.display = 'none';
                    inicializarFiltroMeses();
                    mudarMes(); // Carrega o primeiro m√™s
                }
            });
        }

        function limparValor(val) {
            if(!val) return 0;
            if(typeof val === 'number') return val;
            let v = val.replace("R$", "").replace(/\./g, "").replace(",", ".").trim();
            v = v.replace(/[^0-9.-]/g, '');
            return parseFloat(v) || 0;
        }

        function extrairMes(dataStr) {
            if(!dataStr) return "";
            if(dataStr.includes('/')) {
                let p = dataStr.split('/');
                if(p.length >= 3) return p[2].trim() + "-" + p[1].trim();
            }
            let d = new Date(dataStr);
            if(!isNaN(d)) return d.getFullYear() + "-" + (d.getMonth()+1).toString().padStart(2,'0');
            return "";
        }

        // --- FILTROS ---
        function inicializarFiltroMeses() {
            let meses = new Set();
            DADOS_BRUTOS.forEach(r => {
                let kData = Object.keys(r).find(k=>k.toLowerCase().trim()==='data');
                if(kData && r[kData]) {
                    let m = extrairMes(r[kData]);
                    if(m.length > 4) meses.add(m);
                }
            });
            let sorted = Array.from(meses).sort().reverse();
            let sel = document.getElementById("selMes");
            
            // Adiciona op√ß√£o "Todos"
            let optAll = document.createElement("option"); optAll.value = "todos"; optAll.text = "Todos os Per√≠odos";
            sel.appendChild(optAll);

            sorted.forEach(m => {
                let opt = document.createElement("option");
                let [ano, mes] = m.split('-');
                let nomes = ["","Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
                opt.value = m;
                opt.text = `${nomes[parseInt(mes)]}/${ano}`;
                sel.appendChild(opt);
            });

            // Tenta selecionar m√™s atual
            let hoje = new Date();
            let atual = hoje.getFullYear() + "-" + (hoje.getMonth()+1).toString().padStart(2,'0');
            if(sorted.includes(atual)) sel.value = atual;
            else if(sorted.length > 0) sel.value = sorted[0];
        }

        function mudarMes() {
            // 1. Reseta filtros interativos ao mudar de m√™s
            FILTRO_INTERATIVO = { categoria: null, pagamento: null };
            document.getElementById('btnLimpar').style.display = 'none';

            // 2. Filtra os dados brutos pelo m√™s selecionado
            let mesSel = document.getElementById("selMes").value;
            
            if(mesSel === 'todos') {
                DADOS_MES_ATUAL = DADOS_BRUTOS;
                document.getElementById('subtituloData').innerText = "Hist√≥rico Completo";
            } else {
                DADOS_MES_ATUAL = DADOS_BRUTOS.filter(r => {
                    let kData = Object.keys(r).find(k=>k.toLowerCase().trim()==='data');
                    return kData && extrairMes(r[kData]) === mesSel;
                });
                let txt = document.getElementById("selMes").options[document.getElementById("selMes").selectedIndex].text;
                document.getElementById('subtituloData').innerText = "Visualizando: " + txt;
            }

            atualizarDashboard();
        }

        function filtrarInterativo(tipo, valor) {
            // Define o filtro
            if(tipo === 'categoria') FILTRO_INTERATIVO.categoria = valor;
            if(tipo === 'pagamento') FILTRO_INTERATIVO.pagamento = valor;
            
            document.getElementById('btnLimpar').style.display = 'inline-block';
            atualizarDashboard();
        }

        function limparFiltrosInterativos() {
            FILTRO_INTERATIVO = { categoria: null, pagamento: null };
            document.getElementById('btnLimpar').style.display = 'none';
            atualizarDashboard();
        }

        // --- CORE: PROCESSAMENTO E RENDERIZA√á√ÉO ---
        function atualizarDashboard() {
            // Come√ßa com os dados do m√™s
            let dadosFinais = DADOS_MES_ATUAL;

            // Aplica filtros interativos (BI)
            if(FILTRO_INTERATIVO.categoria) {
                dadosFinais = dadosFinais.filter(r => {
                    let kCat = Object.keys(r).find(k=>k.toLowerCase().trim()==='categoria');
                    return r[kCat] === FILTRO_INTERATIVO.categoria;
                });
            }
            if(FILTRO_INTERATIVO.pagamento) {
                dadosFinais = dadosFinais.filter(r => {
                    let kPgto = Object.keys(r).find(k=>k.toLowerCase().includes('pagamento'));
                    return r[kPgto] === FILTRO_INTERATIVO.pagamento;
                });
            }

            processarMetricas(dadosFinais);
        }

        function processarMetricas(dados) {
            let kpis = { rec:0, desp:0, orc:0 };
            let catsData = {};
            let pgtosData = {};
            let tabela = [];

            dados.forEach(r => {
                let keys = Object.keys(r);
                let kData = keys.find(k=>k.toLowerCase().trim()==='data');
                let kTipo = keys.find(k=>k.toLowerCase().trim()==='tipo');
                let kCat  = keys.find(k=>k.toLowerCase().trim()==='categoria');
                let kSub  = keys.find(k=>k.toLowerCase().includes('sub'));
                let kDesc = keys.find(k=>k.toLowerCase().includes('descri')); // Descri√ß√£o
                let kOrig = keys.find(k=>k.toLowerCase().includes('o que') || k.toLowerCase().includes('origem'));
                let kPgto = keys.find(k=>k.toLowerCase().includes('pagamento'));
                let kValA = keys.find(k=>k.toLowerCase().includes('ajustado'));
                let kVal  = keys.find(k=>k.toLowerCase().trim()==='valor');

                if(!kData || !kTipo) return;

                let tipo = (r[kTipo]||"").toLowerCase().trim();
                let origem = (r[kOrig]||"").toLowerCase().trim();
                let cat = r[kCat] || "Outros";
                let pgto = r[kPgto] || "N√£o inf.";
                let desc = r[kDesc] || "-";

                let vRaw = (kValA && r[kValA]) ? r[kValA] : (r[kVal]||"0");
                let valor = Math.abs(limparValor(vRaw));
                if(valor === 0) return;

                // KPIs e Agrega√ß√µes
                if(origem.includes('realizado')) {
                    if(tipo === 'receita') {
                        kpis.rec += valor;
                    } else if(tipo === 'despesa') {
                        kpis.desp += valor;
                        
                        // Agrega Categoria (Realizado)
                        if(!catsData[cat]) catsData[cat] = {real:0, orc:0};
                        catsData[cat].real += valor;

                        // Agrega Pagamento (Realizado)
                        if(!pgtosData[pgto]) pgtosData[pgto] = 0;
                        pgtosData[pgto] += valor;
                    }
                } else if(origem.includes('or√ßamento')) {
                    if(tipo === 'despesa') {
                        kpis.orc += valor;
                         if(!catsData[cat]) catsData[cat] = {real:0, orc:0};
                        catsData[cat].orc += valor;
                    }
                }

                // Tabela
                let statusBadge = origem.includes('orc') ? '<span class="badge-o">O</span>' : '<span class="badge-r">R</span>';
                tabela.push([
                    r[kData], statusBadge, tipo, cat, r[kSub]||"", desc, pgto, 
                    valor.toLocaleString('pt-BR',{style:'currency', currency:'BRL'})
                ]);
            });

            renderizarKPIs(kpis);
            renderizarGraficos(catsData, pgtosData, kpis);
            renderizarTabela(tabela);
        }

        // --- RENDERIZA√á√ÉO ---
        function renderizarKPIs(k) {
            document.getElementById('kpiReceita').innerText = k.rec.toLocaleString('pt-BR',{style:'currency', currency:'BRL'});
            document.getElementById('kpiDespesa').innerText = k.desp.toLocaleString('pt-BR',{style:'currency', currency:'BRL'});
            document.getElementById('kpiOrcado').innerText = k.orc.toLocaleString('pt-BR',{style:'currency', currency:'BRL'});
            
            let saldo = k.rec - k.desp;
            let elSaldo = document.getElementById('kpiSaldo');
            elSaldo.innerText = saldo.toLocaleString('pt-BR',{style:'currency', currency:'BRL'});
            elSaldo.style.color = saldo >= 0 ? '#27ae60' : '#c0392b';

            let variacao = k.orc - k.desp;
            let elVar = document.getElementById('kpiVariacao');
            elVar.innerText = variacao.toLocaleString('pt-BR',{style:'currency', currency:'BRL'});
            elVar.style.color = variacao >= 0 ? '#27ae60' : '#c0392b';
        }

        function renderizarGraficos(cats, pgtos, kpis) {
            // 1. Categorias (Barra)
            let labelsCat = Object.keys(cats);
            let dReal = labelsCat.map(c => cats[c].real);
            let dOrc = labelsCat.map(c => cats[c].orc);

            if(chartCats) chartCats.destroy();
            chartCats = new Chart(document.getElementById('chartCategorias'), {
                type: 'bar',
                data: {
                    labels: labelsCat,
                    datasets: [
                        { label: 'Planejado', data: dOrc, backgroundColor: '#bdc3c7' },
                        { label: 'Gasto Real', data: dReal, backgroundColor: '#c0392b' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, els) => {
                        if(els.length > 0) {
                            let idx = els[0].index;
                            filtrarInterativo('categoria', labelsCat[idx]);
                        }
                    },
                    plugins: { title: { display: true, text: 'Or√ßado vs Realizado por Categoria (Interativo)' } }
                }
            });

            // 2. Pagamentos (Novo!)
            let labelsPgto = Object.keys(pgtos);
            let dataPgto = Object.values(pgtos);

            if(chartPgtos) chartPgtos.destroy();
            chartPgtos = new Chart(document.getElementById('chartPagamentos'), {
                type: 'doughnut',
                data: {
                    labels: labelsPgto,
                    datasets: [{
                        data: dataPgto,
                        backgroundColor: ['#2ecc71', '#3498db', '#9b59b6', '#f1c40f', '#e67e22', '#e74c3c', '#34495e', '#1abc9c']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, els) => {
                        if(els.length > 0) {
                            let idx = els[0].index;
                            filtrarInterativo('pagamento', labelsPgto[idx]);
                        }
                    },
                    plugins: { 
                        title: { display: true, text: 'Formas de Pagamento (Interativo)' },
                        legend: { position: 'right' }
                    }
                }
            });

            // 3. Gr√°ficos Menores (Visuais)
            if(chartFluxo) chartFluxo.destroy();
            chartFluxo = new Chart(document.getElementById('chartFluxo'), {
                type: 'bar',
                data: {
                    labels: ['Entradas', 'Sa√≠das'],
                    datasets: [{
                        label: 'Total',
                        data: [kpis.rec, kpis.desp],
                        backgroundColor: ['#27ae60', '#c0392b']
                    }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: {display:false}, title: {display:true, text: 'Fluxo Caixa'} } }
            });

             if(chartRecDesp) chartRecDesp.destroy();
            chartRecDesp = new Chart(document.getElementById('chartReceitaDespesa'), {
                type: 'pie',
                data: {
                    labels: ['Receita', 'Despesa'],
                    datasets: [{
                        data: [kpis.rec, kpis.desp],
                        backgroundColor: ['#27ae60', '#c0392b']
                    }]
                },
                options: { maintainAspectRatio: false, plugins: { title: {display:true, text: 'Propor√ß√£o'} } }
            });
        }

        function renderizarTabela(rows) {
            if ($.fn.DataTable.isDataTable('#tabelaDados')) {
                $('#tabelaDados').DataTable().destroy();
            }
            $('#tabelaDados').DataTable({
                data: rows,
                language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json" },
                pageLength: 5,
                order: [[0, 'desc']],
                columnDefs: [
                    { width: "5%", targets: 1 }, // Largura pequena para o Status
                    { width: "30%", targets: 5 } // Largura maior para Descri√ß√£o
                ]
            });
        }
    </script>
</body>
</html>